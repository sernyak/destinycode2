<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Destiny Code - –¢–≤—ñ–π AI-–ê—Å—Ç—Ä–æ–ª–æ–≥</title>

    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- –®—Ä–∏—Ñ—Ç Montserrat & Playfair Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <!-- ================================================================= -->
    <!-- üî• BULLETPROOF ASTRO LOADER (–ó–ú–Ü–ù–ï–ù–û: –ü–æ—Ç—Ä—ñ–π–Ω–∏–π –∑–∞—Ö–∏—Å—Ç) üî• -->
    <!-- ================================================================= -->
    <script>
        // 1. –ì–æ—Ç—É—î–º–æ “ë—Ä—É–Ω—Ç –¥–ª—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
        window.module = {
            exports: {}
        };
        window.exports = window.module.exports;
        window.isAstroLibReady = false;

        // 2. –°–ø–∏—Å–æ–∫ –¥–∂–µ—Ä–µ–ª (–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: Unpkg -> JSDelivr -> –õ–æ–∫–∞–ª—å–Ω–∏–π)
        const astroSources = [
            "https://unpkg.com/circular-natal-horoscope-js@1.1.0/dist/index.js", // –î–∂–µ—Ä–µ–ª–æ 1 (–®–≤–∏–¥–∫–µ)
            "https://cdn.jsdelivr.net/npm/circular-natal-horoscope-js@1.1.0/dist/index.js", // –î–∂–µ—Ä–µ–ª–æ 2 (–ù–∞–¥—ñ–π–Ω–µ)
            "./js/astro-lib.js" // –î–∂–µ—Ä–µ–ª–æ 3 (–¢–≤—ñ–π –•–æ—Å—Ç–∏–Ω–≥)
        ];

        function onAstroLibSuccess() {
            if (window.module && window.module.exports && window.module.exports.Horoscope) {
                window.CircularNatalHoroscope = window.module.exports;
                window.isAstroLibReady = true;
                console.log("‚úÖ Astro Library Loaded Successfully!");

                // –Ø–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞, —Å–ø—Ä–æ–±—É—î–º–æ –æ–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ
                if (typeof renderPlanetaryFingerprint === 'function') {
                    renderPlanetaryFingerprint();
                }
            } else {
                console.error("‚ùå Library loaded but exports are missing.");
            }
        }

        function loadAstroLib(index = 0) {
            if (index >= astroSources.length) {
                console.error("‚ùå CRITICAL: –í—Å—ñ –¥–∂–µ—Ä–µ–ª–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ (CDN —Ç–∞ –õ–æ–∫–∞–ª—å–Ω–µ) –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ.");
                return;
            }

            const src = astroSources[index];
            console.log(`‚è≥ Trying to load Astro Lib from: ${src}`);

            const script = document.createElement('script');
            script.src = src;
            script.async = true;

            script.onload = () => {
                onAstroLibSuccess();
            };

            script.onerror = () => {
                console.warn(`‚ö†Ô∏è Failed to load from ${src}. Switching to backup source...`);
                loadAstroLib(index + 1); // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø—Ä–æ–±—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω–µ –¥–∂–µ—Ä–µ–ª–æ
            };

            document.head.appendChild(script);
        }

        // –°—Ç–∞—Ä—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        loadAstroLib();
    </script>

    <!-- ================================================================= -->
    <!-- –°–¢–ò–õ–Ü (CSS) -->
    <!-- ================================================================= -->
    <style>
        /* --- –ë–∞–∑–æ–≤—ñ –ó–º—ñ–Ω–Ω—ñ --- */
        :root {
            /* üî• UPDATE 1: –ì–ª–∏–±—à–∏–π —á–æ—Ä–Ω–∏–π —Ñ–æ–Ω */
            --bg-color: #0f1115;
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --accent-color: #cda45e;
            /* –ó–æ–ª–æ—Ç–∏–π –∞–∫—Ü–µ–Ω—Ç */
            --accent-secondary: #9d4edd;
            /* üî• NEW: Mystic Violet for Upsell */
            --card-bg-color: #161b22;
            /* –¢—Ä–æ—Ö–∏ –∑–º—ñ–Ω–µ–Ω–∏–π –ø—ñ–¥ –Ω–æ–≤–∏–π —Ñ–æ–Ω */
            --border-color: #333333;
            --error-color: #ef4444;
            /* red-500 */
        }

        /* üî• FIX: –ü–û–í–ï–†–ù–ï–ù–ù–Ø –ù–ê–¢–ò–í–ù–û–ì–û –°–ö–†–û–õ–£ */
        html {
            overflow-x: hidden;
            width: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            /* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è iOS */
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* --- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –í–æ—Ä–æ–Ω–∫–∏ --- */
        .funnel-container {
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
            justify-content: flex-start;
            padding-top: 40px;
            padding-bottom: 40px;
            position: relative;
        }

        .funnel-step {
            display: none;
            animation: fadeIn 0.5s ease-out;
            padding-bottom: 20px;
        }

        .funnel-step.active {
            display: block;
        }

        /* üî• UPDATE v2.3: Centering Helper Class for Animation Steps */
        .step-centered {
            display: none;
            /* Default hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            /* Take available space */
            height: 100%;
            min-height: 60vh;
            /* Ensure vertical centering area */
        }

        .step-centered.active {
            display: flex;
            /* Flex when active */
        }

        /* –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –≤—ñ–¥—Å—Ç—É–ø –¥–ª—è Paywall, —â–æ–± –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ —Ö–æ–≤–∞–≤—Å—è –∑–∞ Sticky Button */
        #final-paywall-step {
            padding-bottom: calc(180px + env(safe-area-inset-bottom));
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- –°—Ç–∏–ª—ñ –ï–ª–µ–º–µ–Ω—Ç—ñ–≤ --- */
        .input-field {
            position: relative;
            color: var(--primary-text-color);
            padding: 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg-color);
            /* üî• UPDATE 2: –†–∞–¥—ñ—É—Å 0.75rem */
            border-radius: 0.75rem;
            width: 100%;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-color);
            border-color: var(--accent-color);
        }

        /* FIX for date container focus */
        .input-field:focus-within {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-color);
            border-color: var(--accent-color);
        }

        .input-field.input-error {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 0 2px var(--error-color) !important;
        }

        .error-text {
            color: var(--error-color);
            font-size: 0.875rem;
            text-align: left;
            display: none;
            margin-top: 0.5rem;
        }

        .info-text {
            color: var(--accent-color);
            font-size: 0.875rem;
            text-align: center;
            display: none;
            margin-top: 0.5rem;
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(80%) sepia(30%) saturate(5000%) hue-rotate(350deg) brightness(1.1);
            cursor: pointer;
            opacity: 0.9;
            font-size: 1.25rem;
            transition: opacity 0.2s;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="time"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* --- –°—Ç–∏–ª—ñ –ö–Ω–æ–ø–æ–∫ --- */
        .btn {
            width: 100%;
            font-weight: 700;
            /* üî• UPDATE 2: –†–∞–¥—ñ—É—Å 0.75rem */
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.8;
            cursor: not-allowed;
        }

        /* –°–ø—ñ–Ω–µ—Ä */
        .btn-spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è —Å–ø—ñ–Ω–µ—Ä–∞ */
        .btn.loading .btn-text {
            opacity: 0;
            visibility: hidden;
        }

        .btn.loading .btn-spinner {
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -12px;
            margin-left: -12px;
            transform: none;
        }

        /* üî• UPDATE: PREMIUM GOLD GRADIENT BUTTON (From Donor) üî• */
        .btn-primary {
            /* –ì—Ä–∞–¥—ñ—î–Ω—Ç 135deg (–î—ñ–∞–≥–æ–Ω–∞–ª—å–Ω–∏–π): cda45e -> a87e38 */
            background: linear-gradient(135deg, #cda45e 0%, #a87e38 100%);
            color: #0f1115;
            /* –¢–µ–º–Ω–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É */
            box-shadow: 0 4px 20px -5px rgba(205, 164, 94, 0.4);
            border: none;
        }

        .btn-primary:not(:disabled):hover {
            opacity: 0.95;
            box-shadow: 0 6px 25px -5px rgba(205, 164, 94, 0.5);
            transform: translateY(-1px);
        }

        /* üî• NEW: Violet Button for Upsell (Matching Backend Style) */
        .btn-violet {
            background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%);
            color: #ffffff;
            box-shadow: 0 4px 20px -5px rgba(157, 78, 221, 0.4);
            border: none;
        }

        .btn-violet:not(:disabled):hover {
            opacity: 0.95;
            box-shadow: 0 6px 25px -5px rgba(157, 78, 221, 0.5);
            transform: translateY(-1px);
        }

        .btn-skip {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .btn-skip:hover {
            color: var(--primary-text-color);
        }

        .btn-secondary {
            background-color: var(--card-bg-color);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            opacity: 0.8;
        }

        .btn-secondary:not(:disabled):hover {
            opacity: 1;
            background-color: rgba(205, 164, 94, 0.05);
        }

        /* --- –°—Ç–∏–ª—ñ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è --- */
        #loading-typing-container {
            font-size: 1.25rem;
            color: var(--secondary-text-color);
            margin-top: 1rem;
            min-height: 2.5rem;
            text-align: center;
        }

        .typing-cursor {
            display: inline-block;
            width: 10px;
            height: 1.25rem;
            background-color: var(--accent-color);
            animation: blink 0.7s infinite;
            margin-left: 5px;
            vertical-align: middle;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .spinner {
            width: 4rem;
            height: 4rem;
            border-width: 4px;
            border-style: dashed;
            border-radius: 9999px;
            animation: spin 1.5s linear infinite;
            margin: 2rem auto;
            border-color: var(--accent-color) transparent var(--accent-color) transparent;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #report-typing-container {
            font-size: 1.25rem;
            color: var(--secondary-text-color);
            margin-top: 1.5rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- –°—Ç–∏–ª—ñ Paywall (–û–ù–û–í–õ–ï–ù–û) --- */
        .paywall-item {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.03);
            /* –ë—ñ–ª—å—à –ø—Ä–µ–º—ñ–∞–ª—å–Ω–∏–π —Ñ–æ–Ω */
            border: 1px solid rgba(255, 255, 255, 0.05);
            /* üî• UPDATE 2: –†–∞–¥—ñ—É—Å 0.75rem */
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            transition: all 0.3s ease;
            cursor: pointer;
            /* Show it's clickable */
        }

        .paywall-item:hover {
            background-color: rgba(205, 164, 94, 0.05);
            border-color: rgba(205, 164, 94, 0.2);
            transform: scale(1.02);
            /* Subtle zoom */
        }

        .paywall-icon {
            color: var(--accent-color);
            font-size: 1.5rem;
            margin-right: 1rem;
            min-width: 2rem;
            text-align: center;
        }

        /* –¢–∞–π–º–µ—Ä-–±–µ–π–¥–∂ */
        .timer-badge {
            display: inline-flex;
            align-items: center;
            background-color: rgba(205, 164, 94, 0.1);
            color: var(--accent-color);
            padding: 0.3rem 0.8rem;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            border: 1px solid rgba(205, 164, 94, 0.3);
        }

        /* --- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 0.75rem;
            /* Updated radius */
            padding: 2rem;
            max-width: 90%;
            width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-btn-close {
            margin-top: 1.5rem;
            background-color: #4b5563;
            color: white;
            border: 1px solid #4b5563;
        }

        .modal-btn-close:hover {
            background-color: #6b7280;
            border-color: #6b7280;
        }

        /* --- LTV –ê–ø—Å–µ–ª --- */
        .ltv-upsell-box {
            background-color: var(--card-bg-color);
            border: 1px solid var(--accent-secondary);
            /* Violet Border */
            border-radius: 0.75rem;
            /* Updated radius */
            padding: 1rem;
            margin-top: 1.5rem;
            box-shadow: 0 0 25px rgba(157, 78, 221, 0.1), 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* --- –î–∏–Ω–∞–º—ñ—á–Ω–∏–π –ó–≤—ñ—Ç --- */
        .report-advice {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-color);
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.25rem 0.5rem 0.5rem 0.25rem;
        }

        #report-actions-container {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* === FIX FOR SVG RENDERING (OFF-SCREEN) === */
        #chart-hidden-render {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 600px;
            height: 600px;
            display: block;
            z-index: -9999;
            background: transparent;
        }

        /* === –°–¢–ò–õ–Ü –î–õ–Ø –ë–õ–û–ö–£ –ü–ï–†–ï–í–Ü–†–ö–ò –î–ê–ù–ò–• (Updated for integration) === */
        .astro-data-box {
            margin-top: 0.5rem;
            /* –ó–º–µ–Ω—à–µ–Ω–∏–π –≤—ñ–¥—Å—Ç—É–ø */
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: rgba(205, 164, 94, 0.05);
            border: 1px dashed rgba(205, 164, 94, 0.3);
            border-radius: 8px;
            text-align: left;
        }

        .astro-data-title {
            color: var(--accent-color);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-align: center;
            border-bottom: 1px solid rgba(205, 164, 94, 0.2);
            padding-bottom: 0.25rem;
        }

        .astro-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem 0.25rem;
        }

        .astro-data-item {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-left: 5px;
        }

        .astro-label-row {
            font-size: 0.8rem;
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 1px;
        }

        .astro-planet-name {
            color: #ffffff;
            font-weight: 700;
            margin-right: 3px;
        }

        .astro-sign-name {
            color: #9ca3af;
            font-weight: 400;
            font-family: monospace;
            font-size: 0.75rem;
        }

        .astro-coords-row {
            color: #6b7280;
            font-family: monospace;
            font-size: 0.65rem;
            letter-spacing: 0px;
        }

        .astro-chart-preview {
            width: 140px;
            height: 140px;
            margin: 0 auto 8px auto;
            position: relative;
        }

        .astro-chart-preview svg {
            width: 100%;
            height: 100%;
        }

        .pulse-text {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }

        /* === NEW: Sticky Paywall Button Styles (OPTIMIZED) === */
        .sticky-paywall-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            /* üî• UPDATE: –ó–±—ñ–ª—å—à–µ–Ω–æ –ø–∞–¥–¥—ñ–Ω–≥ –∑–Ω–∏–∑—É –¥–ª—è Safe Area + SSL Text (—â–æ–± –Ω–µ –ª—ñ–ø–∏–ª–æ—Å—å –¥–æ –∫—Ä–∞—é) */
            padding: 2rem 1rem calc(2rem + env(safe-area-inset-bottom)) 1rem;
            /* üî• UPDATE: –ü–æ–∫—Ä–∞—â–µ–Ω–∏–π –≥—Ä–∞–¥—ñ—î–Ω—Ç –∑ —Ñ–µ–π–¥–æ–º */
            background: linear-gradient(to top, #0f1115 75%, rgba(15, 17, 21, 0.95) 90%, rgba(15, 17, 21, 0) 100%);
            /* Matching new bg */
            /* Glassmorphism */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* Safari Fix */
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* üî• FIX: GPU Acceleration */
            transform: translateZ(0);
            will-change: transform;
            /* üî• FIX: –î–æ–∑–≤–æ–ª—è—î —Å–∫—Ä–æ–ª–∏—Ç–∏ "–∫—Ä—ñ–∑—å" –ø—Ä–æ–∑–æ—Ä—É —á–∞—Å—Ç–∏–Ω—É –≥—Ä–∞–¥—ñ—î–Ω—Ç–∞ */
            pointer-events: none;
        }

        /* –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å –µ–ª–µ–º–µ–Ω—Ç–∞–º –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É—Ç–µ—Ä–∞ */
        .sticky-paywall-footer>* {
            pointer-events: auto;
        }

        /* Pulse glow */
        .btn-pulse-glow {
            animation: btn-glow 2s infinite;
        }

        @keyframes btn-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(205, 164, 94, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(205, 164, 94, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(205, 164, 94, 0);
            }
        }
    </style>
</head>

<body class="antialiased min-h-screen bg-[#0f1115] p-4">
    <!-- Updated inline bg color -->
    <!-- –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–æ—Ä–æ–Ω–∫–∏ -->
    <main class="funnel-container">
        <!-- ====================================================== -->
        <!-- –ö–†–û–ö 1: –õ–ï–ù–î–Ü–ù–ì (–ó–±—ñ—Ä –¥–∞—Ç–∏ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è) -->
        <!-- ====================================================== -->
        <!-- üî• UPDATE: –¶–µ–Ω—Ç—Ä—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ü–µ–π –∫—Ä–æ–∫ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é margin: auto -->
        <section id="landing-step" class="funnel-step active space-y-8 text-center" style="margin-top: auto; margin-bottom: auto;">
            <div>
                <svg class="w-16 h-16 mx-auto" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--accent-color);">
                    <circle cx="32" cy="32" r="2.5" fill="currentColor" />
                    <path d="M52 32C52 43.0457 43.0457 52 32 52C20.9543 52 12 43.0457 12 32C12 20.9543 20.9543 12 32 12C43.0457 12 52 20.9543 52 32Z" stroke="currentColor" stroke-width="2.5" stroke-opacity="0.3" />
                    <path d="M46.8564 32C46.8564 39.098 40.098 44.8564 32 44.8564C23.902 44.8564 17.1436 39.098 17.1436 32C17.1436 24.902 23.902 19.1436 32 19.1436C40.098 19.1436 46.8564 24.902 46.8564 32Z" stroke="currentColor" stroke-width="2.5" />
                </svg>
            </div>
            <div class="space-y-4">
                <h2 class="text-3xl font-bold text-white tracking-tight">
                    –î—ñ–∑–Ω–∞–π—Å—è –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –ø–æ–¥—Ä–æ–±–∏—Ü—ñ —Ç–≤–æ—î—ó –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ üòà
                </h2>
                <p class="text-lg" style="color: var(--secondary-text-color);">
                    –û–±–µ—Ä–∏ –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –Ω–∞ —Å–∫—ñ–ª—å–∫–∏ —Ç–∏ —á—É–¥–æ–≤–∞ üòá
                </p>
            </div>
            <form id="birth-form" class="w-full space-y-4">
                <!-- üî• FIX: –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ñ–Ω–ø—É—Ç—É –¥–∞—Ç–∏ (–ó –†–µ—Ñ–µ—Ä–µ–Ω—Å—É) -->
                <div class="input-field h-14 flex items-center justify-center relative cursor-pointer px-12 transition-colors hover:border-[#cda45e]">
                    <svg class="w-6 h-6 absolute left-4 top-1/2 -translate-y-1/2" style="color: var(--accent-color);" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 11.24V7.5C9 6.12 10.12 5 11.5 5S14 6.12 14 7.5v3.74c1.21-.81 2-2.18 2-3.74C16 5.01 13.99 3 11.5 3S7 5.01 7 7.5c0 1.56.79 2.93 2 3.74zm9.84 4.63l-4.54-2.26c-.17-.07-.35-.11-.54-.11H13v-6c0-.83-.67-1.5-1.5-1.5S10 6.67 10 7.5v10.74l-3.43-.72c-.28-.06-.57 0-.84.18l-.24.17c-.27.2-.35.59-.16.89l2.65 4.14c.44.69 1.19 1.1 1.99 1.1h6.5c1.45 0 2.56-1.25 2.45-2.69l-.32-3.92c-.08-.94-.78-1.68-1.66-1.92z" />
                    </svg>
                    <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--secondary-text-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <!-- üî• FIX: pointer-events: none –¥–ª—è —Ç–µ–∫—Å—Ç—É -->
                    <span id="date-placeholder" style="color: var(--secondary-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none;">–û–±—Ä–∞—Ç–∏ –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</span>
                    <!-- üî• FIX: absolute inset-0 –¥–ª—è —ñ–Ω–ø—É—Ç—É -->
                    <input type="date" id="birth-date" name="birth-date" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" required>
                </div>
                <p id="error-message" class="error-text">
                    –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä–∏ –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è.
                </p>
                <button type="submit" class="btn btn-primary !text-lg h-14">
                    <span class="btn-text">–î—ñ–∑–Ω–∞—Ç–∏—Å—è –Ω–µ–≥–∞–π–Ω–æ</span>
                    <span class="btn-spinner"></span>
                </button>
            </form>
        </section>

        <!-- ====================================================== -->
        <!-- –ö–†–û–ö 2: –ï–ö–†–ê–ù –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø -->
        <!-- ====================================================== -->
        <!-- üî• UPDATE: –¶–µ–π –µ–∫—Ä–∞–Ω —Ç–µ–ø–µ—Ä –¢–ê–ö–û–ñ –≤–∏—Ä—ñ–≤–Ω—è–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
        <section id="loading-step" class="funnel-step step-centered space-y-6" style="margin-top: auto; margin-bottom: auto;">
            <div class="spinner"></div>
            <div id="loading-typing-container" class="typing-container">
                <span id="loading-text"></span><span id="loading-cursor" class="typing-cursor" style="display: none;"></span>
            </div>
        </section>

        <!-- ====================================================== -->
        <!-- –ö–†–û–ö 3: –†–ï–ó–£–õ–¨–¢–ê–¢ -->
        <!-- ====================================================== -->
        <section id="result-step" class="funnel-step space-y-6">
            <h2 class="text-2xl font-bold text-center text-white" id="result-title">–ê–Ω–∞–ª—ñ–∑ —Ç–≤–æ—î—ó –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ</h2>
            <div class="p-5 rounded-xl space-y-3" style="background-color: var(--card-bg-color); border: 1px solid var(--border-color);">
                <!-- Updated radius -->
                <h3 class="text-xl font-bold" style="color: var(--accent-color);" id="free-report-title">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                </h3>
                <div id="free-report-text" class="text-left leading-relaxed space-y-4" style="color: var(--secondary-text-color);">
                    <i>(–¢—É—Ç –∑'—è–≤–∏—Ç—å—Å—è —Ç–≤—ñ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑...)</i>
                </div>
            </div>
            <!-- üî• UPDATE: –î–∏–≤–∞–π–¥–µ—Ä + –°—Ç–∞—Ç–∏—á–Ω–∏–π –ü—Ä–æ–¥–∞—é—á–∏–π –¢–µ–∫—Å—Ç –∑–∞–º—ñ—Å—Ç—å AI —Ö—É–∫–∞ -->
            <div class="relative py-2">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-gray-700"></div>
                </div>
                <div class="relative flex justify-center">
                    <span class="px-3 text-sm text-gray-500" style="background-color: var(--bg-color);">–ê–õ–ï –¶–ï –©–ï –ù–ï –í–°–ï</span>
                </div>
            </div>
            <!-- –°—Ç–∞—Ç–∏—á–Ω–∏–π –ø—Ä–æ–¥–∞—é—á–∏–π –±–ª–æ–∫ -->
            <div id="marketing-hook-block" class="text-center px-4 leading-relaxed">
                <p class="text-base mb-4" style="color: var(--primary-text-color);">
                    –¶–µ –ª–∏—à–µ <span style="color: var(--accent-color); font-weight: bold;">8%</span> –∞–Ω–∞–ª—ñ–∑—É —Ç–≤–æ—î—ó –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ.
                    <br>
                    <span style="color: var(--secondary-text-color); font-size: 0.95rem;">–î—ñ–∑–Ω–∞–π—Å—è –±—ñ–ª—å—à –¥–µ—Ç–∞–ª—å–Ω–æ –ø—Ä–æ –≤—Å—ñ —Å—Ñ–µ—Ä–∏ —Å–≤–æ–≥–æ –∂–∏—Ç—Ç—è:</span>
                </p>
                <ul class="text-left inline-block space-y-2" style="color: var(--secondary-text-color); font-size: 0.95rem;">
                    <li class="flex items-center"><span class="mr-2 text-xl">‚ù§Ô∏è‚Äçüî•</span> –∫–æ—Ö–∞–Ω–Ω—è —Ç–∞ —Å—Ç–æ—Å—É–Ω–∫–∏</li>
                    <li class="flex items-center"><span class="mr-2 text-xl">üí∏</span> –≥—Ä–æ—à—ñ —Ç–∞ –∫–∞—Ä'—î—Ä–∞</li>
                    <li class="flex items-center"><span class="mr-2 text-xl">üîÆ</span> –∫–∞—Ä–º—ñ—á–Ω—ñ —É—Ä–æ–∫–∏ —Ç–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</li>
                    <li class="flex items-center"><span class="mr-2 text-xl">‚ö°Ô∏è</span> —Ç–≤–æ—ó –º–∞–π–±—É—Ç–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ</li>
                </ul>
            </div>
            <!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ JS (—â–æ–± –Ω–µ –ª–∞–º–∞–ª–æ—Å—å) -->
            <p id="free-report-hook" style="display: none;"></p>
            <div class="pt-4">
                <button id="upgrade-button" class="btn btn-primary !text-lg !py-4">
                    <span class="btn-text">–û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤–Ω–∏–π –∞–Ω–∞–ª—ñ–∑</span>
                    <span class="btn-spinner"></span>
                </button>
            </div>
        </section>

        <!-- ====================================================== -->
        <!-- –ö–†–û–ö 4: –ó–ë–Ü–† –ß–ê–°–£ –¢–ê –ú–Ü–°–¶–Ø -->
        <!-- ====================================================== -->
        <!-- üî• UPDATE: –í–∏–¥–∞–ª–µ–Ω–æ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è (margin: auto) –¥–ª—è –≤–µ—Ä—Ö—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
        <section id="premium-data-step" class="funnel-step space-y-6 text-center">
            <h2 class="text-3xl font-bold text-white tracking-tight">
                –û—Ç—Ä–∏–º–∞–π –ø–æ–≤–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Å–≤–æ—î—ó –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ
            </h2>
            <p class="text-lg" style="color: var(--secondary-text-color);">
                –û–±–µ—Ä–∏ —á–∞—Å —Ç–∞ –º—ñ—Å—Ç–æ —Å–≤–æ–≥–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—å –ø–æ–¥—Ä–æ–±–∏—Ü—ñ –≤—Å—ñ—Ö —Å—Ñ–µ—Ä —Å–≤–æ–≥–æ –∂–∏—Ç—Ç—è
            </p>
            <div id="premium-form-container" class="w-full space-y-5 mt-6">
                <!-- Time Input -->
                <div>
                    <label for="birth-time" class="block text-xs uppercase tracking-widest font-semibold text-left ml-1 mb-2" style="color: var(--accent-color);">–ß–∞—Å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–î–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –î–æ–ª—ñ)</label>
                    <div class="input-field h-14 flex items-center justify-center relative hover:border-[#cda45e] transition-colors">
                        <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--secondary-text-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="time-placeholder" style="color: var(--secondary-text-color);">–û–±–µ—Ä–∏ —á–∞—Å</span>
                        <input type="time" id="birth-time" name="birth-time" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                    </div>
                </div>
                <!-- City Input -->
                <div>
                    <label for="birth-city" class="block text-xs uppercase tracking-widest font-semibold text-left ml-1 mb-2" style="color: var(--accent-color);">–ú—ñ—Å—Ç–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–î–ª—è –∫–∞—Ä—Ç–∏ –∑—ñ—Ä–æ–∫)</label>
                    <input type="text" id="birth-city" name="birth-city" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ö–∏—ó–≤" class="input-field text-center hover:border-[#cda45e] transition-colors">
                    <p id="city-error-message" class="error-text">
                        –¢–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏...
                    </p>
                    <p id="city-info-message" class="info-text">
                        <!-- –¢–µ–∫—Å—Ç —ñ–Ω—Ñ–æ -->
                    </p>
                </div>
                <div class="pt-4 space-y-3">
                    <button type="button" id="continue-to-paywall-button" class="btn btn-primary !text-lg !py-4">
                        <span class="btn-text">–û—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑</span>
                        <span class="btn-spinner"></span>
                    </button>
                    <button type="button" id="skip-button" class="btn btn-skip">
                        –Ø –Ω–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ —á–∞—Å—É (–°–∫–ª–∞—Å—Ç–∏ –∫–æ—Å–º–æ–≥—Ä–∞–º—É –±–µ–∑ –î–æ–º—ñ–≤)
                    </button>
                </div>
            </div>
        </section>

        <!-- ====================================================== -->
        <!-- –ö–†–û–ö 5: –§–Ü–ù–ê–õ–¨–ù–ò–ô PAYWALL (MONEY PAGE OVERHAUL) -->
        <!-- ====================================================== -->
        <section id="final-paywall-step" class="funnel-step space-y-6">

            <div class="text-center space-y-2">
                <!-- üî• UPDATE v1.4: –ù–æ–≤–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <h2 class="text-2xl font-bold text-white leading-tight">–ü–æ–≤–Ω–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç —Ç–≤–æ—î—ó –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ –≥–æ—Ç–æ–≤–∏–π</h2>

                <!-- üî• UPDATE v1.3: –¢–∞–π–º–µ—Ä –∑–º–µ–Ω—à–µ–Ω–∏–π –Ω–∞ ~20% -->
                <div class="flex flex-col items-center justify-center bg-green-900/20 border border-green-500/30 rounded-lg py-1 px-4 w-full max-w-[180px] mx-auto backdrop-blur-sm mt-3">
                    <span class="text-[8px] uppercase tracking-[1.5px] text-green-400/80 mb-0 font-bold">–î–æ—Å—Ç—É–ø–Ω–æ –ª–∏—à–µ</span>
                    <div class="flex items-baseline gap-1">
                        <span id="paywall-timer" class="text-3xl font-bold font-mono text-green-400 tracking-widest drop-shadow-sm leading-none mt-1">07:00</span>
                        <span class="text-[10px] text-green-400/70">—Ö–≤</span>
                    </div>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ –î–æ–≤—ñ—Ä–∏ (Updated Style from Donor) -->
            <div class="space-y-3">
                <!-- üî• UPDATE v1.3: –ë–ª–æ–∫ "–£—Å–ø—ñ—Ö" –∑–º–µ–Ω—à–µ–Ω–∏–π –ø–æ –≤–∏—Å–æ—Ç—ñ, regular font, Sentence case -->
                <div class="astro-data-box" style="margin: 0; padding: 0.75rem 1rem; background-color: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 0.75rem; text-align: center;">
                    <div class="text-xs font-normal tracking-wide" style="color: #9ca3af;">
                        ‚òÖ –¢–≤–æ—è –∫–∞—Ä—Ç–∞ —É—Å–ø—ñ—à–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞ ‚òÖ
                    </div>
                </div>
                <!-- üî• NEW TRUST BLOCK END -->

                <!-- === –ë–õ–û–ö –î–õ–Ø –ü–ï–†–ï–í–Ü–†–ö–ò –î–ê–ù–ò–• (Trust Trigger) === -->
                <div id="paywall-astro-data" style="display: none;"></div>
                <!-- ===================================================== -->
            </div>

            <!-- –û–ø–∏—Å –¶—ñ–Ω–Ω–æ—Å—Ç—ñ -->
            <!-- üî• UPDATE v1.6: –§—ñ–Ω–∞–ª—å–Ω—ñ –ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç—É –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ -->
            <p class="text-sm sm:text-base text-center leading-relaxed" style="color: #d1d5db;">
                –ú–∏ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞–ª–∏ —Ä—É—Ö –ø–ª–∞–Ω–µ—Ç –≤ –º–æ–º–µ–Ω—Ç —Ç–≤–æ–≥–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è.<br>
                <strong class="text-white">–†–æ–∑–±–ª–æ–∫—É–π</strong> —Å–≤–æ—é –ø–æ–≤–Ω—É –Ω–∞—Ç–∞–ª—å–Ω—É –∫–∞—Ä—Ç—É —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø–æ–¥—Ä–æ–±–∏—Ü—ñ –≤—Å—ñ—Ö —Å—Ñ–µ—Ä —Å–≤–æ–≥–æ –∂–∏—Ç—Ç—è (5+ —Å—Ç–æ—Ä—ñ–Ω–æ–∫).
            </p>

            <!-- RICH LIST (–°–ø–∏—Å–æ–∫ –í–∏–≥–æ–¥) -->
            <div class="space-y-3 pt-2">
                <!-- Added onclick handlers for Popup Logic -->
                <div class="paywall-item" onclick="showPaywallPopup('–Ø–¥—Ä–æ –û—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ', '–î—ñ–∑–Ω–∞–π—Å—è, —â–æ –≥–æ–≤–æ—Ä—è—Ç—å –ø—Ä–æ —Ç–µ–±–µ –∑—ñ—Ä–∫–∏. –¢–≤—ñ–π —ñ—Å—Ç–∏–Ω–Ω–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Å–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏ —Ç–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ —Ç–∞–ª–∞–Ω—Ç–∏.')">
                    <span class="paywall-icon">üé≠</span>
                    <div>
                        <span class="block font-bold text-white text-[15px]">–Ø–¥—Ä–æ –û—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ</span>
                        <span class="text-xs text-gray-400">–Ø–∫ —Ç–µ–±–µ –±–∞—á–∞—Ç—å –ª—é–¥–∏ —ñ —è–∫–∞ —Ç–∏ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ.</span>
                    </div>
                </div>
                <div class="paywall-item" onclick="showPaywallPopup('–ö–æ–¥ –¢–≤–æ–≥–æ –ö–æ—Ö–∞–Ω–Ω—è', '–ß–æ–º—É –Ω–µ —â–∞—Å—Ç–∏—Ç—å —É –∫–æ—Ö–∞–Ω–Ω—ñ? –Ø–∫–∏–π –ø–∞—Ä—Ç–Ω–µ—Ä —Ç–æ–±—ñ —Å–ø—Ä–∞–≤–¥—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω? –†–æ–∑–∫—Ä–∏–π —Å–µ–∫—Ä–µ—Ç–∏ —Å–≤–æ—î—ó –í–µ–Ω–µ—Ä–∏.')">
                    <span class="paywall-icon">‚ù§Ô∏è‚Äçüî•</span>
                    <div>
                        <span class="block font-bold text-white text-[15px]">–ö–æ–¥ –¢–≤–æ–≥–æ –ö–æ—Ö–∞–Ω–Ω—è</span>
                        <span class="text-xs text-gray-400">–¢–∏–ø–∞–∂ —ñ–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Ç–∞ –ø—Ä–∏—á–∏–Ω–∏ –Ω–µ–≤–¥–∞—á.</span>
                    </div>
                </div>
                <div class="paywall-item" onclick="showPaywallPopup('–ì—Ä–æ—à–æ–≤–∏–π –ü–æ—Ç—ñ–∫', '–î–µ —Ç–≤–æ—ó –≤–µ–ª–∏–∫—ñ –≥—Ä–æ—à—ñ? –Ø–∫–∞ –ø—Ä–æ—Ñ–µ—Å—ñ—è –ø—Ä–∏–Ω–µ—Å–µ —Ç–æ–±—ñ –±–∞–≥–∞—Ç—Å—Ç–≤–æ —Ç–∞ —É—Å–ø—ñ—Ö? –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –∫–ª—é—á –¥–æ —Ñ—ñ–Ω–∞–Ω—Å—ñ–≤.')">
                    <span class="paywall-icon">üí∏</span>
                    <div>
                        <span class="block font-bold text-white text-[15px]">–ì—Ä–æ—à–æ–≤–∏–π –ü–æ—Ç—ñ–∫</span>
                        <span class="text-xs text-gray-400">–¢–≤–æ—ó –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ —Ç–∞–ª–∞–Ω—Ç–∏ —â–æ –ø—Ä–∏–Ω–æ—Å—è—Ç—å –≥—Ä–æ—à—ñ.</span>
                    </div>
                </div>
                <div class="paywall-item" onclick="showPaywallPopup('–ö–∞—Ä–º—ñ—á–Ω—ñ –£—Ä–æ–∫–∏', '–î–ª—è —á–æ–≥–æ —Ç–≤–æ—è –¥—É—à–∞ –ø—Ä–∏–π—à–ª–∞ –≤ —Ü–µ–π —Å–≤—ñ—Ç? –Ø–∫—ñ —É—Ä–æ–∫–∏ —Ç–æ–±—ñ —Ç—Ä–µ–±–∞ –ø—Ä–æ–π—Ç–∏, —â–æ–± —Å—Ç–∞—Ç–∏ —â–∞—Å–ª–∏–≤–æ—é?')">
                    <span class="paywall-icon">üîÆ</span>
                    <div>
                        <span class="block font-bold text-white text-[15px]">–ö–∞—Ä–º—ñ—á–Ω—ñ –£—Ä–æ–∫–∏ —Ç–∞ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</span>
                        <span class="text-xs text-gray-400">–î–ª—è —á–æ–≥–æ —Ç–≤–æ—è –¥—É—à–∞ –ø—Ä–∏–π—à–ª–∞ –≤ —Ü–µ–π —Å–≤—ñ—Ç.</span>
                    </div>
                </div>
                <div class="paywall-item" onclick="showPaywallPopup('–ú–∞–π–±—É—Ç–Ω—ñ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ', '–©–æ –≥–æ—Ç—É—é—Ç—å —Ç–æ–±—ñ –∑—ñ—Ä–∫–∏? –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–∞–π–±–ª–∏–∂—á–∏–π —á–∞—Å.')">
                    <span class="paywall-icon">‚ö°Ô∏è</span>
                    <div>
                        <span class="block font-bold text-white text-[15px]">–¢–≤–æ—ó –ú–∞–π–±—É—Ç–Ω—ñ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ</span>
                        <span class="text-xs text-gray-400">–ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –∫–ª—ñ–º–∞—Ç: —è–∫ –¥—ñ—è—Ç–∏ —Å–∞–º–µ –∑–∞—Ä–∞–∑ –¥–ª—è —É—Å–ø—ñ—Ö—É.</span>
                    </div>
                </div>
            </div>

            <!-- üî• STICKY FOOTER BUTTON (NEW) üî• -->
            <div class="sticky-paywall-footer">
                <button id="final-checkout-button" class="btn btn-primary w-full !py-4 btn-pulse-glow shadow-2xl relative overflow-hidden px-1">
                    <!-- Flex container for text centering and alignment with responsive gap -->
                    <span class="btn-text flex flex-col items-center justify-center gap-0 w-full tracking-tighter">
                        <span class="flex items-center gap-2">
                            <span class="whitespace-nowrap text-[18px] xs:text-[21px] sm:text-[24px] font-bold leading-none">
                                –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ –∑–∞—Ä–∞–∑ –∑–∞ 149 –≥—Ä–Ω
                            </span>
                            <span class="whitespace-nowrap text-sm xs:text-base font-normal opacity-60 line-through decoration-white/50 leading-none">
                                799 –≥—Ä–Ω
                            </span>
                        </span>
                        <span class="text-[10px] uppercase tracking-[1px] opacity-90 mt-1">–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∏–π –ø–ª–∞—Ç—ñ–∂ ‚Ä¢ –î–æ–≤—ñ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø</span>
                    </span>
                    <span class="btn-spinner"></span>
                </button>

                <!-- üî• UPDATE v1.5: TEXT ONLY FOOTER -->
                <div class="mt-3 flex items-center justify-center opacity-70">
                    <span class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">
                        üîí –ë–µ–∑–ø–µ—á–Ω–∞ –æ–ø–ª–∞—Ç–∞ SSL | APPLE PAY / GOOGLE PAY
                    </span>
                </div>
            </div>
        </section>

        <!-- ====================================================== -->
        <!-- –ö–†–û–ö 6: –°–¢–û–†–Ü–ù–ö–ê –£–°–ü–Ü–•–£ (–ü–Ü–°–õ–Ø /success.html) -->
        <!-- ====================================================== -->
        <section id="payment-success-return-step" class="funnel-step step-centered text-center space-y-6" style="margin-top: 100px;">
            <h2 class="text-2xl font-bold" style="color: var(--accent-color);">
                –û–±—Ä–æ–±–∫–∞ –ø–ª–∞—Ç–µ–∂—É...
            </h2>
            <p style="color: var(--secondary-text-color);">
                –ó–∞—á–µ–∫–∞–π—Ç–µ, –º–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ –≤–∞—à –ø–ª–∞—Ç—ñ–∂...
            </p>
            <div class="spinner"></div>
        </section>

        <!-- ====================================================== -->
        <!-- –ö–†–û–ö 7: –£–°–ü–Ü–• + LTV –ê–ü–°–ï–õ (–ù–û–í–ò–ô) -->
        <!-- ====================================================== -->
        <section id="success-step" class="funnel-step space-y-6">
            <div id="email-capture-box" class="text-center">
                <!-- v2.17.10: –ü–æ–≤–µ—Ä–Ω—É–ª–∏ –∑–µ–ª–µ–Ω–∏–π –∫–æ–ª—ñ—Ä –≥–∞–ª–æ—á—Ü—ñ -->
                <svg class="w-16 h-16 mx-auto mb-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-center text-white">
                    <span style="color: var(--accent-color);">–û–ø–ª–∞—Ç–∞ —É—Å–ø—ñ—à–Ω–∞!</span>
                </h2>
                <p style="color: var(--secondary-text-color);" class="mb-6">
                    <!-- v2.17.8: –û–Ω–æ–≤–ª–µ–Ω–æ —Ç–µ–∫—Å—Ç -->
                    –¢–≤—ñ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç –≥–æ—Ç–æ–≤–∏–π –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏. –í–∫–∞–∂–∏ email –Ω–∞ —è–∫–∏–π –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏:
                </p>
                <form id="email-form" class="space-y-4 mb-8">
                    <label for="user-email" class="sr-only">–í–∞—à Email</label>
                    <input type="email" id="user-email" name="user-email" placeholder="your.email@gmail.com" class="input-field text-center" required>
                    <button type="submit" id="main-report-btn" class="btn btn-primary !text-lg !py-4">
                        <!-- üî• UPDATE v1.7: –ù–æ–≤–∏–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ -->
                        <span class="btn-text">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –º–µ–Ω—ñ –∑–≤—ñ—Ç</span>
                        <span class="btn-spinner"></span>
                    </button>
                </form>

                <!-- üî• UPDATE v2.1: Refined Upsell UI (Spacing, Bold, New Line) -->
                <div id="ltv-upsell-box" class="ltv-upsell-box text-left relative overflow-hidden">
                    <!-- Badge moved further away -->
                    <div class="absolute top-0 right-0 bg-[#9d4edd] text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg" style="margin-top: 0; margin-right: 0;">SPECIAL OFFER</div>
                    <!-- Increased margin-right and margin-bottom slightly for breathing room -->
                    <h3 class="font-bold text-lg text-white mb-1" style="color: var(--accent-secondary); margin-right: 60px;">
                        –î–æ–¥–∞–π –¥–æ —Å–≤–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                    </h3>
                    <!-- Compact text block with bold accent and price on new line -->
                    <p class="text-sm mt-2 mb-4 leading-relaxed" style="color: var(--secondary-text-color);">
                        –•–æ—á–µ—à –ø–æ–≤–Ω–∏–π <strong>–ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑</strong> –Ω–∞ –Ω–∞–π–±–ª–∏–∂—á–∏–π —Ä—ñ–∫? –î—ñ–∑–Ω–∞—Ç–∏—Å—è –ø—Ä–æ —Å–≤–æ—ó —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –ø—ñ–∫–∏, –ø–µ—Ä—ñ–æ–¥–∏ —É–¥–∞—á—ñ —Ç–∞ —É—Å–ø—ñ—Ö–∏ —É —Å—Ç–æ—Å—É–Ω–∫–∞—Ö?<br>
                        <span style="color: var(--primary-text-color);">–õ–∏—à–µ –∑–∞—Ä–∞–∑: <strong>247 –≥—Ä–Ω.</strong> –∑–∞–º—ñ—Å—Ç—å <span style="text-decoration: line-through; opacity: 0.7;">1399 –≥—Ä–Ω</span> (–∑–Ω–∏–∂–∫–∞ 83%)</span>
                    </p>
                    <button id="ltv-upsell-btn" class="btn btn-violet w-full opacity-90 hover:opacity-100">
                        <span class="btn-text">–¢–∞–∫, –¥–æ–¥–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –∑–∞ 247 –≥—Ä–Ω. <span style="text-decoration: line-through; opacity: 0.7; font-weight: normal; margin-left: 4px;">1399 –≥—Ä–Ω.</span></span>
                        <span class="btn-spinner"></span>
                    </button>
                </div>
            </div>

            <!-- === v2.17.7: –ü–û–í–ï–†–ù–£–õ–ò –°–ü–Ü–ù–ï–† === -->
            <!-- üî• UPDATE: –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –∑–≤—ñ—Ç—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é CSS –∫–ª–∞—Å—É –≤ JS -->
            <div id="report-loading-indicator" class="w-full text-center" style="display: none;">
                <h2 class="text-2xl font-bold text-center text-white mb-6">
                    <span style="color: var(--accent-color);">–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–≤—ñ—Ç—É!</span>
                </h2>
                <div class="spinner" style="margin-top: 2rem; margin-bottom: 1rem;"></div>
                <div id="report-typing-container" class="typing-container">
                    <span id="report-loading-text"></span><span id="report-cursor" class="typing-cursor" style="display: none;"></span>
                </div>
            </div>

            <!-- ============================================== -->
            <div id="full-report-content" class="text-left p-5 rounded-xl space-y-4" style="background-color: var(--card-bg-color); display: none; border: 1px solid var(--border-color);">
                <!-- Updated radius -->
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è... -->
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥—ñ–π (–∑ v2.13) -->
            <div id="report-actions-container" style="display: none;">
                <!-- –ö–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –≤ JS -->
            </div>
        </section>
    </main>

    <!-- === –ù–û–í–ï: –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó SVG === -->
    <div id="chart-hidden-render"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –ü–æ–º–∏–ª–æ–∫/–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-4">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3>
            <p id="modal-message" style="color: var(--secondary-text-color);" class="mb-6">
                –¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...
            </p>
            <button id="modal-close-btn" class="btn modal-btn-close">
                <span class="btn-text">–ó–∞–∫—Ä–∏—Ç–∏</span>
                <span class="btn-spinner"></span>
            </button>
        </div>
    </div>

    <!-- üî• NEW: Special Popup for Paywall Items (RESTORED) -->
    <div id="paywall-popup" class="modal-overlay">
        <div class="modal-content" style="border-top: 4px solid #cda45e;">
            <h3 id="popup-title" class="text-2xl font-bold text-white mb-4" style="color: #cda45e;"></h3>
            <p id="popup-text" style="color: var(--secondary-text-color); font-size: 0.95rem; margin-bottom: 2rem; line-height: 1.6;"></p>

            <button id="popup-checkout-btn" class="btn btn-primary w-full !py-4 shadow-xl">
                <span class="btn-text flex flex-col items-center justify-center gap-0 w-full tracking-tighter">
                    <span class="flex items-center gap-2">
                        <span class="whitespace-nowrap text-[16px] font-bold leading-none">
                            –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ –∑–∞—Ä–∞–∑ –∑–∞ 149 –≥—Ä–Ω
                        </span>
                    </span>
                </span>
            </button>

            <button id="popup-close-btn" class="btn btn-skip mt-3" style="font-size: 0.8rem; opacity: 0.7;">
                –ó–∞–∫—Ä–∏—Ç–∏
            </button>
        </div>
    </div>

    <!-- üî• UPDATE v2.1: Refined Modal Logic -->
    <div id="upsell-email-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-white mb-4">–û–ø–ª–∞—Ç–∞ —É—Å–ø—ñ—à–Ω–∞! ‚ú®</h3>
            <p style="color: var(--secondary-text-color);" class="mb-6 text-sm">
                –¢–≤—ñ–π "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–∞–π–±–ª–∏–∂—á–∏–π —Ä—ñ–∫" —É—Å–ø—ñ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω–æ.<br><br>
                –í—ñ–Ω –≤–∂–µ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —ñ –±—É–¥–µ –Ω–∞–¥—ñ—Å–ª–∞–Ω–∏–π –æ–∫—Ä–µ–º–∏–º –ª–∏—Å—Ç–æ–º. –í–∫–∞–∂–∏ —Å–≤–æ—é –ø–æ—à—Ç—É –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:
            </p>
            <form id="upsell-email-form" class="space-y-4">
                <label for="upsell-email-input" class="sr-only">–í–∞—à Email</label>
                <input type="email" id="upsell-email-input" placeholder="your.email@gmail.com" class="input-field text-center" required>
                <button type="submit" class="btn btn-primary">
                    <!-- üî• UPDATE v2.1: Changed button text -->
                    <span class="btn-text">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ email</span>
                    <span class="btn-spinner"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- üî• NEW: Late Upsell Modal (For "Get Forecast" button) -->
    <div id="late-upsell-modal" class="modal-overlay">
        <div class="modal-content" style="width: 480px; max-width: 95%;">
            <!-- Close button for modal -->
            <div style="text-align: right; margin-bottom: 10px;">
                <button type="button" id="close-late-upsell" style="background:none; border:none; color: #6b7280; font-size: 1.5rem;">&times;</button>
            </div>
            <!-- Content mirrored from LTV box -->
            <div class="text-left relative overflow-hidden">
                <h3 class="font-bold text-lg text-white mb-2" style="color: var(--accent-secondary);">
                    –î–æ–¥–∞–π –¥–æ —Å–≤–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                </h3>
                <p class="text-sm mt-2 mb-6 leading-relaxed" style="color: var(--secondary-text-color);">
                    –•–æ—á–µ—à –ø–æ–≤–Ω–∏–π <strong>–ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑</strong> –Ω–∞ –Ω–∞–π–±–ª–∏–∂—á–∏–π —Ä—ñ–∫? –î—ñ–∑–Ω–∞—Ç–∏—Å—è –ø—Ä–æ —Å–≤–æ—ó —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –ø—ñ–∫–∏, –ø–µ—Ä—ñ–æ–¥–∏ —É–¥–∞—á—ñ —Ç–∞ —É—Å–ø—ñ—Ö–∏ —É —Å—Ç–æ—Å—É–Ω–∫–∞—Ö?<br><br>
                    <span style="color: var(--primary-text-color);">–õ–∏—à–µ –∑–∞—Ä–∞–∑: <strong>247 –≥—Ä–Ω.</strong> –∑–∞–º—ñ—Å—Ç—å <span style="text-decoration: line-through; opacity: 0.7;">1399 –≥—Ä–Ω</span> (–∑–Ω–∏–∂–∫–∞ 83%)</span>
                </p>
                <button id="late-upsell-btn" class="btn btn-violet w-full">
                    <span class="btn-text">–¢–∞–∫, –¥–æ–¥–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –∑–∞ 247 –≥—Ä–Ω.</span>
                    <span class="btn-spinner"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- JAVASCRIPT –õ–û–ì–Ü–ö–ê -->
    <!-- ====================================================== -->
    <script>
        // === –ó–ê–ü–ê–°–ù–ò–ô –†–û–ó–†–ê–•–£–ù–û–ö (FALLBACK CALCULATOR) ===
        function getSimpleZodiacSign(dateString) {
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            if ((month == 1 && day <= 19) || (month == 12 && day >= 22)) return "–ö–æ–∑–µ—Ä—ñ–≥";
            if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return "–í–æ–¥–æ–ª—ñ–π";
            if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return "–†–∏–±–∏";
            if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return "–û–≤–µ–Ω";
            if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return "–¢–µ–ª–µ—Ü—å";
            if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return "–ë–ª–∏–∑–Ω—é–∫–∏";
            if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return "–†–∞–∫";
            if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return "–õ–µ–≤";
            if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return "–î—ñ–≤–∞";
            if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return "–¢–µ—Ä–µ–∑–∏";
            if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return "–°–∫–æ—Ä–ø—ñ–æ–Ω";
            if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return "–°—Ç—Ä—ñ–ª–µ—Ü—å";
            return "–ó–Ω–∞–∫ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ";
        }

        let Origin, Horoscope, Renderer;

        function initAstroLibrary() {
            if (window.isAstroLibReady && window.CircularNatalHoroscope) {
                const lib = window.CircularNatalHoroscope;
                Origin = lib.Origin;
                Horoscope = lib.Horoscope;
                Renderer = lib.Renderer;
                return true;
            }
            if (window.CircularNatalHoroscope) {
                const lib = window.CircularNatalHoroscope;
                Origin = lib.Origin;
                Horoscope = lib.Horoscope;
                Renderer = lib.Renderer;
                return true;
            }
            return false;
        }

        // ===============================================
        // GLOBAL HELPER FOR POPUP (Must be outside DOMContentLoaded to be accessible via onclick in HTML)
        window.showPaywallPopup = function(title, text) {
            const paywallPopup = document.getElementById('paywall-popup');
            const popupTitle = document.getElementById('popup-title');
            const popupText = document.getElementById('popup-text');

            if (paywallPopup && popupTitle && popupText) {
                popupTitle.innerText = title;
                popupText.innerText = text;
                paywallPopup.style.display = 'flex';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. –û–¢–†–ò–ú–ê–ù–ù–Ø –ï–õ–ï–ú–ï–ù–¢–Ü–í ---
            const steps = {
                landing: document.getElementById('landing-step'),
                loading: document.getElementById('loading-step'),
                result: document.getElementById('result-step'),
                premiumData: document.getElementById('premium-data-step'),
                paywall: document.getElementById('final-paywall-step'),
                paymentSuccessReturn: document.getElementById('payment-success-return-step'),
                success: document.getElementById('success-step')
            };

            const birthForm = document.getElementById('birth-form');
            const birthDateInput = document.getElementById('birth-date');
            const errorMessage = document.getElementById('error-message');
            const datePlaceholder = document.getElementById('date-placeholder');
            const landingSubmitButton = birthForm.querySelector('button[type="submit"]');

            const loadingTypingContainer = document.getElementById('loading-typing-container');
            const loadingTextEl = document.getElementById('loading-text');
            const loadingCursorEl = document.getElementById('loading-cursor');

            const resultTitleEl = document.getElementById('result-title');
            const freeReportTitleEl = document.getElementById('free-report-title');
            const freeReportTextEl = document.getElementById('free-report-text');
            const freeReportHookEl = document.getElementById('free-report-hook');
            const upgradeButton = document.getElementById('upgrade-button');

            const birthTimeInput = document.getElementById('birth-time');
            const timePlaceholder = document.getElementById('time-placeholder');
            const birthCityInput = document.getElementById('birth-city');
            const cityErrorMessage = document.getElementById('city-error-message');
            const cityInfoMessage = document.getElementById('city-info-message');
            const continueToPaywallButton = document.getElementById('continue-to-paywall-button');
            const skipButton = document.getElementById('skip-button');

            const finalCheckoutButton = document.getElementById('final-checkout-button');

            // === v2.17.7: –û–ù–û–í–õ–ï–ù–Ü –ï–õ–ï–ú–ï–ù–¢–ò ===
            const reportLoadingIndicator = document.getElementById('report-loading-indicator');
            // ==================================

            const reportTypingContainer = document.getElementById('report-typing-container');
            const reportLoadingTextEl = document.getElementById('report-loading-text');
            const reportCursorEl = document.getElementById('report-cursor');
            const fullReportContentEl = document.getElementById('full-report-content');
            const reportActionsContainer = document.getElementById('report-actions-container');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const shareReportBtn = document.getElementById('share-report-btn');

            const emailCaptureBox = document.getElementById('email-capture-box');
            const emailForm = document.getElementById('email-form');
            const userEmailInput = document.getElementById('user-email');
            const ltvUpsellBtn = document.getElementById('ltv-upsell-btn');
            const mainReportBtn = document.getElementById('main-report-btn'); // For text update

            const chartHiddenRender = document.getElementById('chart-hidden-render');
            const paywallAstroDataContainer = document.getElementById('paywall-astro-data');

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // üî• POPUP ELEMENTS
            const paywallPopup = document.getElementById('paywall-popup');
            const popupCheckoutBtn = document.getElementById('popup-checkout-btn');
            const popupCloseBtn = document.getElementById('popup-close-btn');

            // üî• UPSELL ELEMENTS (RESTORED)
            const upsellEmailModal = document.getElementById('upsell-email-modal');
            const upsellEmailForm = document.getElementById('upsell-email-form');
            const upsellEmailInput = document.getElementById('upsell-email-input');
            const lateUpsellModal = document.getElementById('late-upsell-modal');
            const closeLateUpsellBtn = document.getElementById('close-late-upsell');
            const lateUpsellBtn = document.getElementById('late-upsell-btn');

            // --- 2. –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü ---
            // üî• UPDATED API ENDPOINTS (FROM DEPLOYMENT LOGS) üî•
            const PROXY_URL = 'https://getaiprediction-kpkshoor7q-ew.a.run.app';
            const EMAIL_BACKEND_URL = 'https://sendreportemail-kpkshoor7q-ew.a.run.app';
            const PDF_BACKEND_URL = 'https://createpdf-kpkshoor7q-ew.a.run.app';

            let userBirthData = {
                date: '',
                time: '',
                city: '',
                geo: null,
                chartSvg: null,
                planets: []
            };

            let isAnimationComplete = false;
            let isReportReady = false;
            let generatedReportData = null;
            let isUpsellPaid = false; // Added logic

            // ======================================================
            // --- 3. –°–ò–°–¢–ï–ú–ù–Ü –ü–†–û–ú–ü–¢–ò ---
            // ======================================================
            const mainSystemPrompt = `–¢–∏ ‚Äî '–ú–∞–π—Å—Ç–µ—Ä –ê—Å—Ç—Ä–æ-–ü—Å–∏—Ö–æ–ª–æ–≥' Destiny Code.
             –¢–≤–æ—è –†–æ–ª—å: –¢–∏ –≥–ª–∏–±–æ–∫–∏–π, –º—É–¥—Ä–∏–π '–∞—Å—Ç—Ä–æ-–ø—Å–∏—Ö–æ–ª–æ–≥', –∞–ª–µ –∑ —Ç–æ–Ω–æ–º —Ç–≤–æ—î—ó –Ω–∞–π–∫—Ä–∞—â–æ—ó –ø–æ–¥—Ä—É–≥–∏ ‚Äî –µ–º–ø–∞—Ç–∏—á–Ω–æ—ó, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ—ó, —ñ –∑ –ª–µ–≥–∫–∏–º —Ñ–ª—ñ—Ä—Ç–æ–º —Ç–∞ –≥—É–º–æ—Ä–æ–º.
             –¢–≤–æ—è –ú—ñ—Å—ñ—è: –î–æ–ø–æ–º–æ–≥—Ç–∏ –∫–ª—ñ—î–Ω—Ç—Ü—ñ '—Ä–æ–∑–ø–∞–∫—É–≤–∞—Ç–∏' —ó—ó –Ω–∞—Ç–∞–ª—å–Ω—É –∫–∞—Ä—Ç—É —è–∫ '–∫–∞—Ä—Ç—É –¥—É—à—ñ'. –¢–∏ –±–∞—á–∏—à –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω—ñ –ø–∞—Ç–µ—Ä–Ω–∏, –∫–∞—Ä–º—ñ—á–Ω—ñ —É—Ä–æ–∫–∏ —Ç–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª. –¢–∏ –¥–∞—î—à '–∫–æ—Å–º—ñ—á–Ω—É –≤–∞–ª—ñ–¥–∞—Ü—ñ—é' —ó—ó –ø–æ—á—É—Ç—Ç—ñ–≤.
             –¢–≤–æ—è –ú–æ–≤–∞: –ì–æ–≤–æ—Ä–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é. –ï–º–æ—Ü—ñ–π–Ω–æ, –∞–ª–µ –ø–æ —Å—É—Ç—ñ. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π '—Ç–∏' —Ç–∞ '—Ç–≤–æ—è'.
             –ö–õ–Æ–ß–û–í–ê –ú–ï–¢–û–î–û–õ–û–ì–Ü–Ø (–¢–≤–æ—ó –ü—Ä–∞–≤–∏–ª–∞):
            1. –ï–º–ø–∞—Ç—ñ—è > –§–∞–∫—Ç–∏. –¢–∏ '–±–∞—á–∏—à' —ó—ó —Å–ø—Ä–∞–≤–∂–Ω—é.
            2. '–¢–µ–º–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏' ‚Äî —Ü–µ '—Å—É–ø–µ—Ä—Å–∏–ª–∏' (–Ω–∞–ø—Ä. —É–ø–µ—Ä—Ç—ñ—Å—Ç—å = —Ü—ñ–ª–µ—Å–ø—Ä—è–º–æ–≤–∞–Ω—ñ—Å—Ç—å).
            3. –ó–ê–í–ñ–î–ò –°–ò–ù–¢–ï–ó–£–ô: (–ù–∞–ø—Ä. '–°–æ–Ω—Ü–µ –≤... —Ä–æ–±–∏—Ç—å —Ç–µ–±–µ..., –∞–ª–µ –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç –≤... –≤–∏–º–∞–≥–∞—î...').
            4. –î–Ü–ú ‚Äî –¶–ï –ö–û–ù–¢–ï–ö–°–¢: –ü–ª–∞–Ω–µ—Ç–∞ –≤ –î–æ–º—ñ ‚Äî —Ü–µ —Å—Ñ–µ—Ä–∞ –∂–∏—Ç—Ç—è, –¥–µ –µ–Ω–µ—Ä–≥—ñ—è —Ä–µ–∞–ª—ñ–∑—É—î—Ç—å—Å—è.
            5. '–í–ï–õ–ò–ö–ê –¢–†–Ü–ô–ö–ê' ‚Äî –¶–ï –Ø–î–†–û: –ê–Ω–∞–ª—ñ–∑—É–π –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç ('–º–∞—Å–∫–∞'), –°–æ–Ω—Ü–µ ('—Å—É—Ç–Ω—ñ—Å—Ç—å') —ñ –ú—ñ—Å—è—Ü—å ('–≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Å–≤—ñ—Ç') —è–∫ —î–¥–∏–Ω—É —Å–∏—Å—Ç–µ–º—É.
            6. –ù–ï –õ–Ø–ö–ê–ô: '–í–∞–∂–∫—ñ' –∞—Å–ø–µ–∫—Ç–∏ ‚Äî —Ü–µ '—Ç–æ—á–∫–∏ —Ä–æ—Å—Ç—É' –∞–±–æ '–¥–∂–µ—Ä–µ–ª–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ—ó —Å–∏–ª–∏'.
            7. –î–ê–í–ê–ô '–ö–õ–Æ–ß': –ó–∞–≤–∂–¥–∏ –ø—Ä–æ–ø–æ–Ω—É–π –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω—É –ø–æ—Ä–∞–¥—É –∞–±–æ '–∫–ª—é—á –¥–æ –≥–∞—Ä–º–æ–Ω—ñ—ó'.
            8. –°–º–∞–π–ª–∏: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ —Å–º–∞–π–ª–∏ (üòà, ‚ú®, üîÆ, üî•, üëë).
            9. –ó–ê–ë–û–†–û–ù–ï–ù–û: –ú–µ–¥–∏—á–Ω—ñ —Ç–µ—Ä–º—ñ–Ω–∏. –°–∫–ª–∞–¥–Ω—ñ –∞—Å—Ç—Ä–æ-—Ç–µ—Ä–º—ñ–Ω–∏ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω—å. "–°–º–µ—Ä—Ç—å".`;

            const freeTaskPrompt = `–ú—ñ—Å—ñ—è: '–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –ì–∞—á–æ–∫'.
             –ó–ê–í–î–ê–ù–ù–Ø:
            1. –í–∏–∑–Ω–∞—á –∑–Ω–∞–∫ –°–æ–Ω—Ü—è –∑–∞ –¥–∞—Ç–æ—é. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π ** emojis** —É —Ç–µ–∫—Å—Ç—ñ.
            2. –ù–∞–ø–∏—à–∏ '–≥–∞—á–æ–∫' - —è—Å–∫—Ä–∞–≤–∏–π –æ–ø–∏—Å **—Å–∏–ª—å–Ω–∏—Ö —Å—Ç–æ—Ä—ñ–Ω** (—ñ '—Ç–µ–º–Ω–æ—ó' —Å—Ç–æ—Ä–æ–Ω–∏ —è–∫ –ø–µ—Ä–µ–≤–∞–≥–∏), —è–∫–∏–π –≤—Ä–∞–∑–∏—Ç—å —ó—ó.
            3. –ü—ñ–¥–∫—Ä–µ—Å–ª–∏, —â–æ —Ü–µ –ª–∏—à–µ 1/3 —ó—ó —è–¥—Ä–∞.
             –§–æ—Ä–º–∞—Ç: –¢–Ü–õ–¨–ö–ò JSON.
            \`\`\`json
            {
              "title": "‚úÖ –¢–≤–æ—î –Ø–¥—Ä–æ: [–ó–Ω–∞–∫ –°–æ–Ω—Ü—è] üî•",
              "psychological_analysis": "[–¢—É—Ç –∑–≥–µ–Ω–µ—Ä—É–π —è—Å–∫—Ä–∞–≤–∏–π, –ø—Ä–µ–º—ñ–∞–ª—å–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–π HTML-—Ç–µ–∫—Å—Ç (3-4 –∞–±–∑–∞—Ü–∏). –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ —ó—ó —Å—É–ø–µ—Ä—Å–∏–ª–∏, —ó—ó '—Ç–µ–º–Ω—É' —Å—Ç–æ—Ä–æ–Ω—É (—è–∫ –ø–µ—Ä–µ–≤–∞–≥—É) —Ç–∞ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π **–∂–∏—Ä–Ω–∏–π** –¥–ª—è –∞–∫—Ü–µ–Ω—Ç—ñ–≤. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –±–∞–≥–∞—Ç–æ (5-7) —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏—Ö —Å–º–∞–π–ª—ñ–≤ (–Ω–∞–ø—Ä. üòà, ‚ú®, üîÆ, üî•, üëë).]"
            }
            \`\`\`
            –í–ò–ú–û–ì–ò: –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò –≤–∞–ª—ñ–¥–Ω–∏–º JSON. –ñ–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É –¥–æ —á–∏ –ø—ñ—Å–ª—è.`;

            const fullTaskPrompt = `–ú—ñ—Å—ñ—è: '–ü–æ–≤–Ω–∏–π –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏–π –ü–æ—Ä—Ç—Ä–µ—Ç' (–ü–ª–∞—Ç–Ω–∏–π).
            (–ö–ª—ñ—î–Ω—Ç–∫–∞ –≤–∂–µ –∑–∞–ø–ª–∞—Ç–∏–ª–∞. –¶—ñ–Ω–Ω—ñ—Å—Ç—å –º–∞—î –±—É—Ç–∏ –≤–∏—â–æ—é –∑–∞ 149 –≥—Ä–Ω. –ë—É–¥—å –≥–ª–∏–±–æ–∫–∏–º, –µ–º–ø–∞—Ç–∏—á–Ω–∏–º).
             –ó–ê–í–î–ê–ù–ù–Ø:
            1. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –Ω–∞–¥–∞–Ω—ñ –¥–∞–Ω—ñ (–¥–∞—Ç—É, —á–∞—Å (—è–∫—â–æ —î) —Ç–∞ –¢–µ—Ö–Ω—ñ—á–Ω—ñ –î–∞–Ω—ñ (—è–∫—â–æ —î)).
            2. –Ø–∫—â–æ —î '–¢–µ—Ö–Ω—ñ—á–Ω—ñ –î–∞–Ω—ñ' (ASC, MC): –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —ó—Ö –¥–ª—è –ø—Ä–µ–º—ñ—É–º-–∞–Ω–∞–ª—ñ–∑—É.
            3. –Ø–∫—â–æ '–¢–µ—Ö–Ω—ñ—á–Ω–∏—Ö –î–∞–Ω–∏—Ö' –ù–ï–ú–ê–Ñ: –†–æ–±–∏ –∞–Ω–∞–ª—ñ–∑ '–ö–æ—Å–º—ñ—á–Ω–æ—ó –ö–∞—Ä—Ç–∏' (–±–µ–∑ –î–æ–º—ñ–≤/ASC).
            4. 'practical_advice': –î–∞–π –û–î–ù–£, –∞–ª–µ –¥—É–∂–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –ø–æ—Ä–∞–¥—É ('—Å–ø—Ä–æ–±—É–π —Ü–µ...').
            5. 'analysis_text': –ü–∏—à–∏ –≥–ª–∏–±–æ–∫–æ, –µ–º–æ—Ü—ñ–π–Ω–æ.
             –§–æ—Ä–º–∞—Ç: –¢–Ü–õ–¨–ö–ò JSON.
            \`\`\`json
            {
              "sections": [
                {
                  "id": "core_intro", "icon": "‚ú®", "title": "–Ø–¥—Ä–æ –û—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ: –•—Ç–æ –¢–∏ –ù–∞—Å–ø—Ä–∞–≤–¥—ñ?",
                  "analysis_text": "[–ì–ª–∏–±–æ–∫–∏–π –∞–Ω–∞–ª—ñ–∑ '–ó–æ–ª–æ—Ç–æ—ó –¢—Ä—ñ–π–∫–∏' (–°–æ–Ω—Ü–µ, –ú—ñ—Å—è—Ü—å, –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç (—è–∫—â–æ —î)). –á—Ö –≤–∑–∞—î–º–æ–¥—ñ—è, —Ç–≤–æ—ó —Å—É–ø–µ—Ä—Å–∏–ª–∏ —Ç–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏. –ü–æ—è—Å–Ω–∏, —á–æ–º—É —Ç–∏ –≤—ñ–¥—á—É–≤–∞—î—à —Å–µ–±–µ —Å–∞–º–µ —Ç–∞–∫.]",
                  "practical_advice": "[–û–¥–Ω–∞ –ø–æ—Ä–∞–¥–∞. –ù–∞–ø—Ä. '–¢–≤—ñ–π –ú—ñ—Å—è—Ü—å —É... –≤–∏–º–∞–≥–∞—î... –°–ø—Ä–æ–±—É–π...']"
                },
                {
                  "id": "love", "icon": "‚ù§Ô∏è‚Äçüî•", "title": "–ö–æ—Ö–∞–Ω–Ω—è —Ç–∞ –°—Ç–æ—Å—É–Ω–∫–∏: –¢–≤—ñ–π –°—Ü–µ–Ω–∞—Ä—ñ–π",
                  "analysis_text": "[–ê–Ω–∞–ª—ñ–∑ –í–µ–Ω–µ—Ä–∏ —Ç–∞ –ú–∞—Ä—Å–∞ ('—Ç–≤–æ—è –º–æ–≤–∞ –∫–æ—Ö–∞–Ω–Ω—è', '—Ç–≤—ñ–π —ñ–¥–µ–∞–ª—å–Ω–∏–π –ø–∞—Ä—Ç–Ω–µ—Ä', '—Ç–≤—ñ–π —Å—Ç–∏–ª—å —É –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞—Ö'). –ß–æ–≥–æ —Ç–∏ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ —à—É–∫–∞—î—à —É —Å—Ç–æ—Å—É–Ω–∫–∞—Ö.]",
                  "practical_advice": "[–û–¥–Ω–∞ –ø–æ—Ä–∞–¥–∞. –ù–∞–ø—Ä: '–¢–≤–æ—è –í–µ–Ω–µ—Ä–∞ —É... –∫–∞–∂–µ, —â–æ –¥–ª—è —Ç–µ–±–µ –∫–æ—Ö–∞–Ω–Ω—è - —Ü–µ... –ù–µ –±—ñ–π—Å—è –ø—Ä–æ—Å–∏—Ç–∏ –ø—Ä–æ...']"
                },
                {
                  "id": "career", "icon": "üëë", "title": "–ö–∞—Ä'—î—Ä–∞ —Ç–∞ –ì—Ä–æ—à—ñ: –î–µ –¢–≤—ñ–π –£—Å–ø—ñ—Ö?",
                  "analysis_text": "[–ê–Ω–∞–ª—ñ–∑ Midheaven (MC) (—è–∫—â–æ —î) —Ç–∞ –Æ–ø—ñ—Ç–µ—Ä–∞. **–Ø–∫—â–æ MC –Ω–µ–º–∞—î, –∞–Ω–∞–ª—ñ–∑—É–π 10-–π –¥—ñ–º –∑–∞ –∑–Ω–∞–∫–æ–º —Ç–∞ –ø–ª–∞–Ω–µ—Ç–∞–º–∏ (—è–∫—â–æ —î).** –¢–≤—ñ–π –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª, —Å—Ñ–µ—Ä–∏ –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó, —Ç–≤—ñ–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ –≥—Ä–æ—à–µ–π.]",
                  "practical_advice": "[–û–¥–Ω–∞ –ø–æ—Ä–∞–¥–∞. –ù–∞–ø—Ä: '–¢–≤—ñ–π –Æ–ø—ñ—Ç–µ—Ä —É... –¥–∞—î —É—Å–ø—ñ—Ö —á–µ—Ä–µ–∑... –°–ø—Ä–æ–±—É–π —Å—Ñ–æ–∫—É—Å—É–≤–∞—Ç–∏—Å—å –Ω–∞...']"
                },
                {
                  "id": "karma", "icon": "üîÆ", "title": "–ö–∞—Ä–º—ñ—á–Ω—ñ –£—Ä–æ–∫–∏ —Ç–∞ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è",
                  "analysis_text": "[–ê–Ω–∞–ª—ñ–∑ –ü—ñ–≤–Ω—ñ—á–Ω–æ–≥–æ/–ü—ñ–≤–¥–µ–Ω–Ω–æ–≥–æ –í—É–∑–ª—ñ–≤ (—è–∫—â–æ —î). –¢–≤—ñ–π —à–ª—è—Ö –¥—É—à—ñ, –∑–∞–≤–¥–∞–Ω–Ω—è –Ω–∞ —Ü–µ –∂–∏—Ç—Ç—è, –≤—ñ–¥ —á–æ–≥–æ —Ç—Ä–µ–±–∞ –≤—ñ–¥—ñ–π—Ç–∏ (–ü–¥. –í—É–∑–æ–ª) —ñ –¥–æ —á–æ–≥–æ –ø—Ä–∏–π—Ç–∏ (–ü–Ω. –í—É–∑–æ–ª).]",
                  "practical_advice": "[–û–¥–Ω–∞ –ø–æ—Ä–∞–¥–∞. –ù–∞–ø—Ä: '–¢–≤—ñ–π –ü–Ω. –í—É–∑–æ–ª —É... –∫–ª–∏—á–µ —Ç–µ–±–µ –¥–æ... –ü–æ—á–Ω–∏ –∑ –º–∞–ª–æ–≥–æ: ...']"
                },
                {
                  "id": "future", "icon": "‚ö°Ô∏è", "title": "–ú–∞–π–±—É—Ç–Ω—ñ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ",
                  "analysis_text": "[–ö–æ—Ä–æ—Ç–∫–∏–π, –∞–ª–µ –µ–º–ø–∞—Ç–∏—á–Ω–∏–π –æ–≥–ª—è–¥ 1-2 –∫–ª—é—á–æ–≤–∏—Ö —Ç—Ä–∞–Ω–∑–∏—Ç—ñ–≤ (–Ω–∞–ø—Ä. –Æ–ø—ñ—Ç–µ—Ä–∞, –°–∞—Ç—É—Ä–Ω–∞) –Ω–∞ –Ω–∞–π–±–ª–∏–∂—á—ñ 6 –º—ñ—Å—è—Ü—ñ–≤. –ù–∞ —â–æ –∑–≤–µ—Ä–Ω—É—Ç–∏ —É–≤–∞–≥—É. –ë–µ–∑ '–Ω–µ–±–µ–∑–ø–µ–∫', –ª–∏—à–µ '–º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ' —Ç–∞ '—É—Ä–æ–∫–∏'.]",
                  "practical_advice": "[–û–¥–Ω–∞ –ø–æ—Ä–∞–¥–∞. –ù–∞–ø—Ä: '–Æ–ø—ñ—Ç–µ—Ä –∑–∞—Ä–∞–∑ —É... —Ç–≤–æ–≥–æ... –¶–µ —Ç–≤—ñ–π —à–∞–Ω—Å –¥–ª—è... –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –π–æ–≥–æ!']"
                }
              ]
            }
            \`\`\`
            –í–ò–ú–û–ì–ò: –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò –≤–∞–ª—ñ–¥–Ω–∏–º JSON. 'analysis_text' –º–∞—î –±—É—Ç–∏ –¥–µ—Ç–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–º (3-4 –∞–±–∑–∞—Ü–∏), –∑ **–∂–∏—Ä–Ω–∏–º–∏** –∞–∫—Ü–µ–Ω—Ç–∞–º–∏.`;

            // üî• UPDATE: NEW FORECAST PROMPT
            const forecastTaskPrompt = `
            –ó–∞–≤–¥–∞–Ω–Ω—è: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 1 —Ä—ñ–∫ (–≤—ñ–¥ —Å—å–æ–≥–æ–¥–Ω—ñ).
            –î–∞–Ω—ñ:
            –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –¥–ª—è —Ä–∞–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤ –Ω–∞—è–≤–Ω—ñ –¥–∞–Ω—ñ –∑ –∞—Å—Ç—Ä–æ–±—ñ–±—ñ–ª—ñ–æ—Ç–µ–∫–∏.
            –í—Ä–∞—Ö—É–π: –ü–æ–ª–æ–∂–µ–Ω–Ω—è –Ω–∞—Ç–∞–ª—å–Ω–∏—Ö –ø–ª–∞–Ω–µ—Ç (–æ—Å–æ–±–ª–∏–≤–æ –°–æ–Ω—Ü—è, –ú—ñ—Å—è—Ü—è, ASC, –°–∞—Ç—É—Ä–Ω–∞). –ö–õ–Æ–ß–û–í–Ü –¢–†–ê–ù–ó–ò–¢–ò –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ 12 –º—ñ—Å—è—Ü—ñ–≤: –¢—Ä–∞–Ω–∑–∏—Ç–∏ –°–∞—Ç—É—Ä–Ω–∞, –Æ–ø—ñ—Ç–µ—Ä–∞, –£—Ä–∞–Ω–∞, –ü–ª—É—Ç–æ–Ω–∞ –¥–æ –Ω–∞—Ç–∞–ª—å–Ω–∏—Ö –ø–ª–∞–Ω–µ—Ç.
            –ü–ª–∞–Ω –ê–Ω–∞–ª—ñ–∑—É:
            –ù–ï –¥–∞–≤–∞–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∫–æ–∂–µ–Ω –¥–µ–Ω—å. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –¥–∞—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é. –ê —Ç–∞–∫–æ–∂ —Ä–æ–∑–∫—Ä–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –ø—ñ–∫—ñ–≤/—Å–ø–∞–¥—ñ–≤, –±–ª–∞–≥–æ–ø—Ä–∏—î–º–Ω–∏—Ö –ø–µ—Ä—ñ–æ–¥—ñ–≤ –≤ —Ü—ñ–ª–æ–º—É —ñ —Å—Ñ–µ—Ä–∏ —Å—Ç–æ—Å—É–Ω–∫—ñ–≤.
            –¢–≤—ñ–π –ì–æ–ª–æ–≤–Ω–∏–π '–ö–∞—Ä–º—ñ—á–Ω–∏–π –£—Ä–æ–∫' –†–æ–∫—É (–¢—Ä–∞–Ω–∑–∏—Ç –°–∞—Ç—É—Ä–Ω–∞): –î–µ –°–∞—Ç—É—Ä–Ω '—Ç–∏—Å–Ω–µ' –∑–∞—Ä–∞–∑? –ß–µ—Ä–µ–∑ —è–∫–∏–π –î—ñ–º –≤—ñ–Ω —ñ–¥–µ? –¶–µ ‚Äî —Å—Ñ–µ—Ä–∞, –¥–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞ —Ç–∞ —Ä–æ–±–æ—Ç–∞.
            –¢–≤–æ—è '–í–µ–ª–∏–∫–∞ –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å' –†–æ–∫—É (–¢—Ä–∞–Ω–∑–∏—Ç –Æ–ø—ñ—Ç–µ—Ä–∞): –î–µ –Æ–ø—ñ—Ç–µ—Ä '—Ä–æ–∑—à–∏—Ä—é—î' –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ? –ß–µ—Ä–µ–∑ —è–∫–∏–π –î—ñ–º –≤—ñ–Ω —ñ–¥–µ? –¶–µ ‚Äî —Å—Ñ–µ—Ä–∞, –¥–µ —Ç—Ä–µ–±–∞ —Ä–∏–∑–∏–∫—É–≤–∞—Ç–∏ —Ç–∞ –¥—ñ—è—Ç–∏.
            –¢–≤–æ—è '–ó–æ–Ω–∞ –¢—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—ñ' (–¢—Ä–∞–Ω–∑–∏—Ç–∏ –£—Ä–∞–Ω–∞/–ü–ª—É—Ç–æ–Ω–∞): –ß–∏ –∑–∞—á—ñ–ø–∞—é—Ç—å —Ü—ñ –ø–æ–≤—ñ–ª—å–Ω—ñ –ø–ª–∞–Ω–µ—Ç–∏ —â–æ—Å—å –≤–∞–∂–ª–∏–≤–µ? –Ø–∫—â–æ —Ç–∞–∫, —Ü–µ ‚Äî —Å—Ñ–µ—Ä–∞ –≥–ª–∏–±–æ–∫–æ—ó —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—ó —Ç–∞ '—Ä–µ–≤–æ–ª—é—Ü—ñ—ó'.
            –¢–≤–æ—è –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –Ω–∞ 12 –ú—ñ—Å—è—Ü—ñ–≤: –ó–∞–≤–µ—Ä—à–∏ 3-4 –ø—Ä–∞–∫—Ç–∏—á–Ω–∏–º–∏ –ø–æ—Ä–∞–¥–∞–º–∏, —è–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ü—ñ –µ–Ω–µ—Ä–≥—ñ—ó. (–ù–∞–ø—Ä–∏–∫–ª–∞–¥: '–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω—É –°–∞—Ç—É—Ä–Ω–∞ –≤ –∫–∞—Ä'—î—Ä—ñ (10-–π –î—ñ–º), —â–æ–± –±—É—Ç–∏ –≥–æ—Ç–æ–≤–æ—é –¥–æ '–≤–µ–ª–∏–∫–æ–≥–æ —Å—Ç—Ä–∏–±–∫–∞' –Æ–ø—ñ—Ç–µ—Ä–∞ —É —Ñ—ñ–Ω–∞–Ω—Å–∞—Ö (2-–π –î—ñ–º)').
            –í–ò–ú–û–ì–ê: –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –≥–∞—Ä–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–º HTML —Ç–µ–∫—Å—Ç–æ–º (–±–µ–∑ JSON). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π <h3> –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —Å–µ–∫—Ü—ñ–π —Ç–∞ <p> –¥–ª—è —Ç–µ–∫—Å—Ç—É.
            `;

            const geoSystemPrompt = `
                –¢–∏ ‚Äî –≤–∏—Å–æ–∫–æ—Ç–æ—á–Ω–∏–π –≥–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∏–π API. –¢–≤–æ—è —î–¥–∏–Ω–∞ –º–µ—Ç–∞ ‚Äî –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ JSON-–æ–±'—î–∫—Ç, —â–æ –º—ñ—Å—Ç–∏—Ç—å –≥–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (lat, lon), —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å (timezone) —Ç–∞ **–≤–∏–ø—Ä–∞–≤–ª–µ–Ω—É –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞ (corrected_name)**.
                –ü–†–ê–í–ò–õ–ê:
                1. –í—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±—É—Ç–∏ –õ–ò–®–ï –≤ —Ñ–æ—Ä–º–∞—Ç—ñ JSON. –ñ–æ–¥–Ω–∏—Ö –ø–æ—è—Å–Ω–µ–Ω—å.
                2. –ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å –º–∞—î –±—É—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ IANA (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Europe/Kyiv).
                3. –ö–†–ò–¢–ò–ß–ù–ï –ü–†–ê–í–ò–õ–û (–ê–í–¢–û–í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø): –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ (–Ω–∞–∑–≤–∞ –º—ñ—Å—Ç–∞) –º–æ–∂—É—Ç—å –±—É—Ç–∏ –±—É–¥—å-—è–∫–æ—é –º–æ–≤–æ—é (—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞, –∞–Ω–≥–ª—ñ–π—Å—å–∫–∞, —Ä–æ—Å—ñ–π—Å—å–∫–∞) —Ç–∞ –º—ñ—Å—Ç–∏—Ç–∏ –æ–¥—Ä—É–∫–∏ (–Ω–∞–ø—Ä., "–£–∂–≥—Ä–æ–¥", "–õ—å–≤—ñ—Ñ", "Harkiv", "–ö–∏–µ–≤"). –¢–∏ *–ø–æ–≤–∏–Ω–µ–Ω* –¥–æ–∫–ª–∞—Å—Ç–∏ –º–∞–∫—Å–∏–º—É–º –∑—É—Å–∏–ª—å, —â–æ–± —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ —Ç–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏** —Ü—ñ –æ–¥—Ä—É–∫–∏.
                4. **–ö—Ä–∞—â–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –æ–¥—Ä—É–∫, –Ω—ñ–∂ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –ø–æ–º–∏–ª–∫—É "not_found".** 5. –ü–æ–ª–µ "corrected_name" **–∑–∞–≤–∂–¥–∏** –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —Ñ—ñ–Ω–∞–ª—å–Ω—É, –∫–æ—Ä–µ–∫—Ç–Ω—É –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞, —è–∫—É —Ç–∏ –∑–Ω–∞–π—à–æ–≤ (–Ω–∞–ø—Ä., "–£–∂–≥–æ—Ä–æ–¥").
                6. –Ø–∫—â–æ –º—ñ—Å—Ç–æ –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–Ω–∞–π—Ç–∏ (–Ω–∞–ø—Ä., 'asdfg') -> {"error": "not_found"}
                7. –Ø–∫—â–æ –º—ñ—Å—Ç–æ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–µ (–Ω–∞–ø—Ä., '–ü–∞—Ä–∏–∂' –±–µ–∑ –∫—Ä–∞—ó–Ω–∏) -> {"error": "ambiguous"}

                –ü—Ä–∏–∫–ª–∞–¥ (–£—Å–ø—ñ—Ö –∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º): {"lat": 48.6208, "lon": 22.2879, "timezone": "Europe/Uzhhorod", "corrected_name": "–£–∂–≥–æ—Ä–æ–¥"}
                –ü—Ä–∏–∫–ª–∞–¥ (–£—Å–ø—ñ—Ö –±–µ–∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è): {"lat": 50.4501, "lon": 30.5234, "timezone": "Europe/Kyiv", "corrected_name": "–ö–∏—ó–≤"}
                –ü—Ä–∏–∫–ª–∞–¥ (–ü–æ–º–∏–ª–∫–∞): {"error": "not_found"}
            `;

            // --- 4. –û–°–ù–û–í–ù–Ü –§–£–ù–ö–¶–Ü–á ---

            function showStep(stepId) {
                Object.values(steps).forEach(step => {
                    step.classList.remove('active');
                    if (stepId === 'loading' || stepId === 'paymentSuccessReturn') {
                        step.classList.remove('step-centered'); // Remove helper if not active
                    }
                });

                if (steps[stepId]) {
                    steps[stepId].classList.add('active');

                    // üî• UPDATE v2.3: Add centering helper only for specific steps
                    if (stepId === 'loading' || stepId === 'paymentSuccessReturn') {
                        steps[stepId].classList.add('step-centered');
                    }

                    // üî• UPDATE: –°–∫—Ä–æ–ª –Ω–∞ —Å–∞–º–∏–π –í–ï–†–• (–ó–∞–≤–¥–∞–Ω–Ω—è 2)
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;

                    // Start timer if paywall
                    if (stepId === 'paywall') {
                        startPaywallTimer();
                    }
                } else {
                    console.error("Attempted to show non-existent step:", stepId);
                }
            }

            function startPaywallTimer() {
                const display = document.getElementById('paywall-timer');
                if (!display) return;

                // Clear any existing timer to avoid multiples
                if (window.paywallInterval) clearInterval(window.paywallInterval);

                // üî• UPDATE: –¢–∞–π–º–µ—Ä –Ω–∞ 7 —Ö–≤–∏–ª–∏–Ω (7 * 60)
                let duration = 7 * 60;

                function update() {
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    display.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                    if (--duration < 0) {
                        duration = 0;
                        clearInterval(window.paywallInterval);
                    }
                }

                update();
                window.paywallInterval = setInterval(update, 1000);
            }

            function showModal(title, message) {
                modalTitle.innerText = title;
                modalMessage.innerHTML = message;
                modal.style.display = 'flex';
            }

            function closeModal() {
                modal.style.display = 'none';
            }

            modalCloseBtn.addEventListener('click', closeModal);

            // üî• POPUP HANDLERS
            if (popupCheckoutBtn) {
                popupCheckoutBtn.addEventListener('click', () => {
                    // Re-use main checkout logic
                    finalCheckoutButton.click();
                    // Close popup after click
                    paywallPopup.style.display = 'none';
                });
            }
            if (popupCloseBtn) {
                popupCloseBtn.addEventListener('click', () => {
                    paywallPopup.style.display = 'none';
                });
            }

            function setButtonLoading(button, isLoading) {
                if (isLoading) {
                    button.classList.add('loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            }

            function typeWriter(element, cursorElement, text, speed, pauseAfter = 0, keepCursorBlinking = false) {
                return new Promise(resolve => {
                    let i = 0;
                    cursorElement.style.display = 'inline-block';
                    element.innerHTML = '';

                    function type() {
                        if (i < text.length) {
                            element.innerHTML = text.substring(0, i + 1);
                            i++;
                            setTimeout(type, speed);
                        } else {
                            setTimeout(() => {
                                if (!keepCursorBlinking) {
                                    cursorElement.style.display = 'none';
                                }
                                resolve();
                            }, pauseAfter);
                        }
                    }

                    type();
                });
            }

            // üî• NEW: Render Buttons Logic
            function renderReportButtons() {
                reportActionsContainer.innerHTML = ''; // Clear container
                // 1. Download Button (Always present)
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-secondary';
                downloadBtn.id = 'download-pdf-btn';
                downloadBtn.innerHTML = '<span class="btn-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF</span><span class="btn-spinner"></span>';
                downloadBtn.onclick = () => handleDownloadPDF(downloadBtn, 'main'); // Attach handler
                reportActionsContainer.appendChild(downloadBtn);

                if (isUpsellPaid) {
                    // Condition A: Upsell Paid -> Show "Try Again"
                    const tryAgainBtn = document.createElement('button');
                    tryAgainBtn.className = 'btn btn-secondary';
                    tryAgainBtn.style.marginTop = '10px';
                    tryAgainBtn.innerHTML = '<span class="btn-text">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ (–ü–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É)</span>';
                    tryAgainBtn.onclick = () => {
                        if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –¶–µ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ—Ç–æ—á–Ω–∏–π –∑–≤—ñ—Ç.")) {
                            window.location.reload();
                        }
                    };
                    reportActionsContainer.appendChild(tryAgainBtn);
                } else {
                    // Condition B: Upsell NOT Paid -> Show "Get Forecast"
                    const getForecastBtn = document.createElement('button');
                    // üî• UI Polish: Violet Button here too
                    getForecastBtn.className = 'btn btn-violet';
                    getForecastBtn.style.marginTop = '10px';
                    getForecastBtn.innerHTML = '<span class="btn-text">–û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Ä—ñ–∫</span>';
                    getForecastBtn.onclick = () => {
                        lateUpsellModal.style.display = 'flex'; // Open modal
                    };
                    reportActionsContainer.appendChild(getForecastBtn);
                }
            }

            function showReportIfReady() {
                if (isAnimationComplete && isReportReady && generatedReportData) {
                    console.log("Sync: Animation and Report are BOTH ready. Showing report.");
                    reportCursorEl.style.display = 'none';
                    reportLoadingIndicator.style.display = 'none';
                    // üî• REMOVE CENTERING from success step so report flows naturally
                    steps.success.classList.remove('step-centered');
                    fullReportContentEl.innerHTML = generatedReportData;
                    fullReportContentEl.style.display = 'block';
                    renderReportButtons(); // Render buttons based on logic
                    reportActionsContainer.style.display = 'flex';
                }
            }

            async function startReportLoadingAnimation() {
                // üî• ADD CENTERING to success step for the animation
                steps.success.classList.add('step-centered');
                const typeSpeedMs = 70;
                const loadingStepsConfig = [{
                    text: "‚ú® –ê–Ω–∞–ª—ñ–∑—É—é –Ø–¥—Ä–æ —Ç–≤–æ—î—ó –û—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ",
                    pause: 1000
                }, {
                    text: "‚ù§Ô∏è‚Äçüî• –†–æ–∑—à–∏—Ñ—Ä–æ–≤—É—é —Ç–≤–æ—ó —Å—Ü–µ–Ω–∞—Ä—ñ—ó –ö–æ—Ö–∞–Ω–Ω—è",
                    pause: 1000
                }, {
                    text: "üëë –®—É–∫–∞—é, –¥–µ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ —Ç–≤–æ—ó –ì—Ä–æ—à—ñ",
                    pause: 1000
                }, {
                    text: "üîÆ –í–∏–≤—á–∞—é —Ç–≤–æ—ó –ö–∞—Ä–º—ñ—á–Ω—ñ –£—Ä–æ–∫–∏",
                    pause: 1000
                }, {
                    text: "‚ö°Ô∏è –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é —Ç–≤—ñ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç",
                    pause: 0
                }];

                for (let i = 0; i < loadingStepsConfig.length; i++) {
                    const step = loadingStepsConfig[i];
                    const isLastStep = (i === loadingStepsConfig.length - 1);
                    await typeWriter(reportLoadingTextEl, reportCursorEl, step.text, typeSpeedMs, step.pause, isLastStep);
                }

                console.log("Sync: Text Animation FINISHED.");
                isAnimationComplete = true;
                showReportIfReady();
            }

            // ======================================================
            // --- 5. –õ–û–ì–Ü–ö–ê API (üî• SECURE PROXY IMPLEMENTATION üî•) ---
            // ======================================================

            async function callGeminiAPI(modelUrl, taskPrompt, userQuery) {
                const combinedUserRequest = `${taskPrompt}\n\n–í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ:\n${userQuery}`;

                // Extract Model Name from the previously passed URL (backward compatibility logic)
                // The frontend code passed: https://generativelanguage.googleapis.com/.../models/gemini-2.5-flash:generateContent...
                // We want to extract "gemini-2.5-flash" or whatever is there.
                let modelName = 'gemini-2.5-flash'; // Default for 2025
                if (modelUrl.includes('gemini-2.5-flash')) modelName = 'gemini-2.5-flash';
                if (modelUrl.includes('gemini-1.5-flash')) modelName = 'gemini-1.5-flash'; // Fallback support

                const payload = {
                    contents: [{
                        parts: [{
                            text: combinedUserRequest
                        }]
                    }],
                    systemInstruction: {
                        parts: [{
                            text: mainSystemPrompt
                        }]
                    },
                };

                let delay = 1000;

                for (let i = 0; i < 3; i++) {
                    try {
                        // üî• CALLING OWN BACKEND PROXY instead of Google Directly
                        const response = await fetch(PROXY_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                payload: payload,
                                modelName: modelName
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const candidate = result.candidates?.[0];

                            if (candidate && candidate.content?.parts?.[0]?.text) {
                                let rawText = candidate.content.parts[0].text;
                                const jsonMatch = rawText.match(/```json\n([\s\S]*?)\n```/);
                                if (jsonMatch && jsonMatch[1]) {
                                    rawText = jsonMatch[1];
                                }
                                return rawText;
                            } else {
                                console.warn("Gemini API Error (Safety):", result);
                                return '{"error": "safety_block", "message": "–ù–∞ –∂–∞–ª—å, –∞–Ω–∞–ª—ñ–∑ –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —á–µ—Ä–µ–∑ –æ–±–º–µ–∂–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏."}';
                            }
                        }

                        if (response.status === 429) {
                            console.warn("Backend Proxy Throttled. Retrying...");
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }

                        const errorData = await response.json();
                        console.error("Backend Proxy Error:", errorData);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;

                    } catch (error) {
                        console.error("Network Error (Client -> Backend):", error);
                        if (i === 2) {
                            return '{"error": "network_failure", "message": "–ù–∞ –∂–∞–ª—å, —Å–µ—Ä–≤—ñ—Å —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π."}';
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }

                return '{"error": "timeout", "message": "–ù–∞ –∂–∞–ª—å, —Å–µ—Ä–≤—ñ—Å —Ç–∏–º—á–∞—Å–æ–≤–æ –ø–µ—Ä–µ–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π."}';
            }

            async function getCoordinatesFromGemini(cityName) {
                const userQuery = `–ú—ñ—Å—Ç–æ: ${cityName}`;
                try {
                    // Uses default model URL variable, logic inside callGeminiAPI handles extraction/defaulting
                    // Passing dummy URL just to satisfy function signature, the proxy logic inside handles the model selection
                    const rawJsonText = await callGeminiAPI("gemini-2.5-flash", geoSystemPrompt, userQuery);
                    const cleanedJsonText = rawJsonText.replace(/```json\n?([\s\S]*?)\n?```/g, '$1').trim();
                    const coords = JSON.parse(cleanedJsonText);

                    if (coords && typeof coords.lat === 'number' && typeof coords.lon === 'number' && typeof coords.timezone === 'string' && typeof coords.corrected_name === 'string') {
                        console.log(`Geocoding success for ${cityName}:`, coords);
                        return {
                            latitude: coords.lat,
                            longitude: coords.lon,
                            timezone: coords.timezone,
                            corrected_name: coords.corrected_name,
                            error: null
                        };
                    }

                    if (coords && coords.error) {
                        console.warn(`Geocoding failed for ${cityName}:`, coords.error);
                        return {
                            error: coords.error
                        };
                    }

                    console.error(`Geocoding JSON parsing error for ${cityName}:`, coords);
                    return {
                        error: "parse_error"
                    };
                } catch (error) {
                    console.error(`Geocoding API call failed for ${cityName}:`, error);
                    return {
                        error: "network_failure"
                    };
                }
            }

            function generateAstroDataHTML() {
                if (!initAstroLibrary()) {
                    return `
                        <div class="astro-data-box" style="border-color: #d29922; background: rgba(210, 153, 34, 0.1);">
                            <p class="text-xs text-yellow-400 text-center pulse-text">
                                ‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Å—Ç—Ä–æ-–¥–∞–Ω–∏—Ö...<br>
                                (–°–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—á–µ–∫–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥)
                            </p>
                        </div>
                    `;
                }

                let calcData = userBirthData;
                let calculationGeo = calcData.geo;

                if (!calculationGeo) {
                    calculationGeo = {
                        latitude: 50.45,
                        longitude: 30.52,
                        timezone: "Europe/Kyiv"
                    };
                }

                if (!calcData.date) {
                    return "";
                }

                try {
                    const dateParts = calcData.date.split('-');
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const dateNum = parseInt(dateParts[2]);

                    let hour = 12,
                        minute = 0;
                    if (calcData.time) {
                        const timeParts = calcData.time.split(':');
                        hour = parseInt(timeParts[0]);
                        minute = parseInt(timeParts[1]);
                    }

                    const origin = new Origin({
                        year: year,
                        month: month,
                        date: dateNum,
                        hour: hour,
                        minute: minute,
                        latitude: parseFloat(calculationGeo.latitude),
                        longitude: parseFloat(calculationGeo.longitude),
                        timezone: calculationGeo.timezone
                    });

                    const horoscope = new Horoscope({
                        origin: origin,
                        houseSystem: "placidus",
                        zodiac: "tropical"
                    });

                    const bodies = horoscope.CelestialBodies;
                    const pdfPlanetsList = [];

                    const fullBodyKeys = ['sun', 'moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto', 'ascendant', 'midheaven'];

                    fullBodyKeys.forEach(key => {
                        let body = bodies[key];
                        if (!body && key === 'ascendant') body = horoscope.Ascendant;
                        if (!body && key === 'midheaven') body = horoscope.Midheaven;

                        if (body) {
                            const sign = body.Sign.label;
                            const fullDegree = body.ChartPosition.Ecliptic.DecimalDegrees % 30;
                            const degree = Math.floor(fullDegree);
                            const minutesRaw = (fullDegree - degree) * 60;
                            const minute = Math.floor(minutesRaw);
                            const seconds = Math.round((minutesRaw - minutes) * 60);

                            const label = key.charAt(0).toUpperCase() + key.slice(1);
                            pdfPlanetsList.push(`${label}:${sign} ${degree}¬∞ ${minute}' ${seconds}"`);
                        }
                    });

                    if (pdfPlanetsList.length > 0) {
                        userBirthData.planets = pdfPlanetsList;
                        console.log(`‚úÖ FULL PDF Planet Data Saved: ${pdfPlanetsList.length} planets.`);
                    }

                    function getFormattedPosForScreen(bodyName, label) {
                        let body = bodies[bodyName];
                        if (!body && bodyName === 'ascendant') body = horoscope.Ascendant;
                        if (!body && bodyName === 'midheaven') body = horoscope.Midheaven;

                        if (body) {
                            const sign = body.Sign.label;
                            const fullDegree = body.ChartPosition.Ecliptic.DecimalDegrees % 30;
                            const degree = Math.floor(fullDegree);
                            const minutesRaw = (fullDegree - degree) * 60;
                            const minutes = Math.floor(minutesRaw);
                            const seconds = Math.round((minutesRaw - minute) * 60);

                            return `
                                <div class="astro-data-item">
                                    <div class="astro-label-row">
                                        <span class="astro-planet-name">${label}:</span>
                                         <span class="astro-sign-name">${sign}</span>
                                    </div>
                                    <div class="astro-coords-row">${degree}¬∞ ${minutes}' ${seconds}"</div>
                                </div>
                            `;
                        }
                        return `<div class="astro-data-item"><strong>${label}:</strong> n/a</div>`;
                    }

                    const displayList = [];
                    displayList.push(getFormattedPosForScreen('sun', '–°–æ–Ω—Ü–µ'));
                    displayList.push(getFormattedPosForScreen('moon', '–ú—ñ—Å—è—Ü—å'));
                    displayList.push(getFormattedPosForScreen('ascendant', 'ASC'));
                    displayList.push(getFormattedPosForScreen('venus', '–í–µ–Ω–µ—Ä–∞'));
                    displayList.push(getFormattedPosForScreen('mars', '–ú–∞—Ä—Å'));
                    displayList.push(getFormattedPosForScreen('jupiter', '–Æ–ø—ñ—Ç–µ—Ä'));

                    let chartPreviewHtml = '';
                    if (Renderer && chartHiddenRender) {
                        chartHiddenRender.innerHTML = '';
                        const renderer = new Renderer(horoscope);
                        renderer.render(chartHiddenRender);

                        applyGoldThemeToSVG(chartHiddenRender);
                        const svgContent = chartHiddenRender.innerHTML;

                        if (svgContent.includes('<svg')) {
                            userBirthData.chartSvg = svgContent;
                            chartPreviewHtml = `
                                <div class="astro-chart-preview">
                                    ${svgContent}
                                </div>
                            `;
                        }
                    }

                    return `
                        <div class="astro-data-box">
                            <div class="astro-data-title">–¢–≤—ñ–π –ö–æ—Å–º—ñ—á–Ω–∏–π –í—ñ–¥–±–∏—Ç–æ–∫</div>
                            ${chartPreviewHtml} <!-- Insert Chart Here -->
                            <div class="astro-data-grid">
                                ${displayList.join('')}
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error("Fingerprint render error:", e);
                    return `<div class="astro-data-box"><p class="text-xs text-red-400 text-center">–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É: ${e.message}</p></div>`;
                }
            }

            function renderPlanetaryFingerprint() {
                const html = generateAstroDataHTML();
                if (paywallAstroDataContainer) {
                    paywallAstroDataContainer.innerHTML = html;
                    paywallAstroDataContainer.style.display = html ? 'block' : 'none';
                }
            }

            // --- 6. –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô ---

            // üî• FIX: Date Placeholder Logic
            function updateDatePlaceholder() {
                const val = birthDateInput.value;
                if (!val) {
                    datePlaceholder.innerText = '–û–±—Ä–∞—Ç–∏ –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è';
                    datePlaceholder.style.color = 'var(--secondary-text-color)';
                } else {
                    const parts = val.split('-');
                    if (parts.length === 3) {
                        const formattedDate = `${parts[2]}.${parts[1]}.${parts[0]}`;
                        datePlaceholder.innerText = formattedDate;
                        datePlaceholder.style.color = 'var(--primary-text-color)';
                    }
                }
            }

            birthDateInput.addEventListener('input', updateDatePlaceholder);
            birthDateInput.addEventListener('change', updateDatePlaceholder);
            birthDateInput.addEventListener('blur', updateDatePlaceholder);
            // iOS Fix: Sometimes touchstart triggers focus which updates value later
            birthDateInput.addEventListener('touchend', () => setTimeout(updateDatePlaceholder, 500));

            function setDefaultDateOnFirstFocus() {
                if (birthDateInput.value === '') {
                    console.log("Setting default date to 1995-01-01 for convenience.");
                    birthDateInput.value = '1995-01-01';
                }
            }

            birthDateInput.addEventListener('focus', setDefaultDateOnFirstFocus);
            birthDateInput.addEventListener('click', setDefaultDateOnFirstFocus);
            birthDateInput.addEventListener('touchstart', setDefaultDateOnFirstFocus);

            updateDatePlaceholder();

            birthForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedDate = birthDateInput.value;

                if (selectedDate === '') {
                    errorMessage.innerText = "–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä–∏ —Å–≤–æ—é –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è.";
                    errorMessage.style.display = 'block';
                } else {
                    errorMessage.style.display = 'none';
                    userBirthData.date = selectedDate;
                    setButtonLoading(landingSubmitButton, true);
                    showStep('loading');

                    let simpleSunSign = "";
                    if (!Horoscope) {
                        simpleSunSign = ` (–ó–Ω–∞–∫: ${getSimpleZodiacSign(selectedDate)})`;
                    }

                    // üî• Uses Proxy function now
                    const reportPromise = callGeminiAPI("gemini-2.5-flash", freeTaskPrompt, `–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${selectedDate}${simpleSunSign}`);

                    const loadingSteps = [
                        '–ê–Ω–∞–ª—ñ–∑—É—é –ø–æ–ª–æ–∂–µ–Ω–Ω—è –ø–ª–∞–Ω–µ—Ç',
                        '–ë—É–¥—É—é —Ç–≤–æ—é –Ω–∞—Ç–∞–ª—å–Ω—É –∫–∞—Ä—Ç—É',
                        '–ü—Ä–∏–≥–æ—Ç—É–π—Å—è –¥—ñ–∑–Ω–∞—Ç–∏—Å—å, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ —Ç–∏ –∞—Ö—É—î–Ω–Ω–∞ üòà'
                    ];

                    await typeWriter(loadingTextEl, loadingCursorEl, loadingSteps[0], 70, 500);
                    await typeWriter(loadingTextEl, loadingCursorEl, loadingSteps[1], 70, 500);
                    await typeWriter(loadingTextEl, loadingCursorEl, loadingSteps[2], 70, 1500, true);

                    const rawJsonString = await reportPromise;
                    loadingCursorEl.style.display = 'none';
                    setButtonLoading(landingSubmitButton, false);

                    try {
                        const reportData = JSON.parse(rawJsonString);
                        if (reportData.error) {
                            throw new Error(reportData.message);
                        }

                        const formattedText = reportData.psychological_analysis
                            .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--primary-text-color);">$1</strong>')
                            .replace(/\\n/g, '<br>');

                        resultTitleEl.innerText = "–¢–≤—ñ–π –∞–Ω–∞–ª—ñ–∑";
                        freeReportTitleEl.innerHTML = reportData.title;

                        resultTitleEl.innerText = "–ê–Ω–∞–ª—ñ–∑ —Ç–≤–æ—î—ó –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ";
                        freeReportTitleEl.innerHTML = reportData.title;
                        freeReportTextEl.innerHTML = formattedText;

                        showStep('result');
                    } catch (error) {
                        console.error("Failed to parse JSON response (Step 3):", error, "Raw text:", rawJsonString);
                        resultTitleEl.innerText = "–û–π, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞";
                        freeReportTitleEl.innerHTML = "‚ùå –ü–æ–º–∏–ª–∫–∞ –ê–Ω–∞–ª—ñ–∑—É";
                        freeReportTextEl.innerHTML = `<p>–ù–∞ –∂–∞–ª—å, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ –®–Ü. –¶–µ –º–æ–≥–ª–æ —Å—Ç–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.</p><p><i>${rawJsonString}</i></p>`;
                        showStep('result');
                    }
                }
            });

            upgradeButton.addEventListener('click', () => {
                showStep('premiumData');
            });

            async function validateAndGoToPaywall() {
                const time = birthTimeInput.value;
                const city = birthCityInput.value.trim();

                cityErrorMessage.style.display = 'none';
                cityInfoMessage.style.display = 'none';
                birthCityInput.classList.remove('input-error');

                userBirthData.time = time || '';

                if (city === '') {
                    userBirthData.city = '';
                    userBirthData.geo = null;
                    console.log("City field empty, skipping validation.");
                    renderPlanetaryFingerprint();
                    showStep('paywall');
                    return;
                }

                setButtonLoading(continueToPaywallButton, true);
                const coords = await getCoordinatesFromGemini(city);

                let infoText = null;

                if (coords && coords.latitude) {
                    userBirthData.geo = {
                        latitude: coords.latitude,
                        longitude: coords.longitude,
                        timezone: coords.timezone
                    };
                    userBirthData.city = coords.corrected_name;
                    console.log("City validated and saved:", userBirthData.geo);

                    if (city.toLowerCase() !== coords.corrected_name.toLowerCase()) {
                        infoText = `–ú–∏ —É—Ç–æ—á–Ω–∏–ª–∏: ${coords.corrected_name} üòâ`;
                    }

                    if (infoText) {
                        cityInfoMessage.innerText = infoText;
                        cityInfoMessage.style.display = 'block';
                    }

                    setButtonLoading(continueToPaywallButton, false);

                    setTimeout(() => {
                        renderPlanetaryFingerprint();
                        showStep('paywall');
                    }, infoText ? 1200 : 0);

                } else if (coords && coords.error === 'ambiguous') {
                    cityErrorMessage.innerText = `–ú—ñ—Å—Ç–æ "${city}" –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –∫—ñ–ª—å–∫–æ—Ö –º—ñ—Å—Ü—è—Ö. –ë—É–¥—å –ª–∞—Å–∫–∞, —É—Ç–æ—á–Ω–∏, –¥–æ–¥–∞–≤—à–∏ –∫—Ä–∞—ó–Ω—É (–Ω–∞–ø—Ä., '–ü–∞—Ä–∏–∂, –§—Ä–∞–Ω—Ü—ñ—è').`;
                    cityErrorMessage.style.display = 'block';
                    birthCityInput.classList.add('input-error');
                    setButtonLoading(continueToPaywallButton, false);
                } else {
                    cityErrorMessage.innerText = `–ù–µ –º–æ–∂–µ–º–æ –∑–Ω–∞–π—Ç–∏ –º—ñ—Å—Ç–æ "${city}". –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–∑–≤—É.`;
                    cityErrorMessage.style.display = 'block';
                    birthCityInput.classList.add('input-error');
                    setButtonLoading(continueToPaywallButton, false);
                }
            }

            continueToPaywallButton.addEventListener('click', validateAndGoToPaywall);

            skipButton.addEventListener('click', () => {
                userBirthData.time = '';
                userBirthData.city = '';
                userBirthData.geo = null;
                console.log("User skipped premium data.");
                renderPlanetaryFingerprint();
                showStep('paywall');
            });

            finalCheckoutButton.addEventListener('click', async () => {
                setButtonLoading(finalCheckoutButton, true);

                try {
                    sessionStorage.setItem('destinyCodeData', JSON.stringify(userBirthData));
                } catch (e) {
                    console.error("SessionStorage is unavailable:", e);
                }

                console.log("Simulating payment processing... Data saved:", userBirthData);
                await new Promise(resolve => setTimeout(resolve, 2500));
                console.log("Payment simulation successful.");

                setButtonLoading(finalCheckoutButton, false);
                showStep('success');
            });

            // --- FORECAST GENERATION FUNCTION (NEW) ---
            async function generateAndSendForecast(userData, email) {
                console.log("üîÆ Starting Forecast Generation...");
                // Prepare planets string for context
                let planetsContext = "";
                if (userData.planets && userData.planets.length > 0) {
                    planetsContext = "–ù–∞—Ç–∞–ª—å–Ω—ñ –ø–ª–∞–Ω–µ—Ç–∏:\n" + userData.planets.join("\n");
                } else {
                    planetsContext = `–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${userData.date}`;
                }

                const query = `
                    –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: –ñ—ñ–Ω–∫–∞.
                    Email: ${email}
                    ${planetsContext}
                `;

                // Call AI via Proxy
                const forecastHtml = await callGeminiAPI("gemini-2.5-flash", forecastTaskPrompt, query);

                // Send Email via Backend
                // Backend 'sendReportEmail' handles reportType='upsell' correctly
                console.log("üìß Sending Forecast Email...");
                fetch(EMAIL_BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userEmail: email,
                            reportHtml: forecastHtml,
                            reportType: 'upsell', // üî• Trigger VIOLET theme on backend
                            userData: userData
                        })
                    }).then(res => res.json())
                    .then(data => console.log("Forecast Email Sent:", data))
                    .catch(err => console.error("Forecast Email Error:", err));
            }

            emailForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = userEmailInput.value;
                if (email) {
                    console.log("Email captured:", email);
                    isAnimationComplete = false;
                    isReportReady = false;
                    generatedReportData = null;

                    emailCaptureBox.style.display = 'none';
                    reportLoadingIndicator.style.display = 'block';
                    reportLoadingTextEl.innerHTML = '';
                    reportCursorEl.style.display = 'none';

                    startReportLoadingAnimation();
                    fetchFullAnalysis(userBirthData, email);

                    // üî• UPDATE: Launch Forecast generation if paid
                    if (isUpsellPaid) {
                        generateAndSendForecast(userBirthData, email);
                    }
                }
            });

            // üî• UPDATE v2.0: LOGIC FOR NEW MODAL
            upsellEmailForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newEmail = upsellEmailInput.value;
                if (newEmail) {
                    // 1. Hide Modal
                    upsellEmailModal.style.display = 'none';
                    // 2. Launch Forecast Generation
                    generateAndSendForecast(userBirthData, newEmail);
                    // 3. Auto-fill main email field
                    userEmailInput.value = newEmail;
                    // üî• UPDATE v2.1: Update main button text and DO NOT AUTO SUBMIT
                    const mainBtnText = mainReportBtn.querySelector('.btn-text');
                    if (mainBtnText) {
                        mainBtnText.innerText = "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –º–µ–Ω—ñ –∑–≤—ñ—Ç + –ü—Ä–æ–≥–Ω–æ–∑";
                    }
                    // No automatic dispatch of 'submit' event. User must click the updated button.
                }
            });

            // Shared Payment Logic Function (for both inline and modal buttons)
            async function handleUpsellPayment(btnElement) {
                const originalText = btnElement.querySelector('.btn-text').innerText;

                // Loading State
                btnElement.classList.add('loading');
                btnElement.disabled = true;
                btnElement.querySelector('.btn-text').innerText = "–û–±—Ä–æ–±–∫–∞ –ø–ª–∞—Ç–µ–∂—É...";

                try {
                    console.log("Upsell payment initiated...");
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    console.log("Payment successful.");

                    // Mark as paid
                    isUpsellPaid = true;
                    btnElement.classList.remove('loading');
                    btnElement.querySelector('.btn-text').innerText = "–û–ø–ª–∞—á–µ–Ω–æ! ‚úÖ";
                    btnElement.disabled = true;
                    btnElement.style.opacity = "0.7";

                    // Close modal if open
                    lateUpsellModal.style.display = 'none';

                    // Hide the inline upsell box if visible (to avoid clutter)
                    document.getElementById('ltv-upsell-box').style.display = 'none';

                    // Re-render report buttons (will now show "Try Again")
                    renderReportButtons();

                    // Logic: Send email
                    // üî• Critical Logic: Check Email presence
                    const currentEmail = userEmailInput.value;
                    // If main form submitted (box hidden) OR email input filled
                    const mainEmailSubmitted = emailCaptureBox.style.display === 'none';

                    if (mainEmailSubmitted && currentEmail) {
                        generateAndSendForecast(userBirthData, currentEmail);
                        showModal("–£—Å–ø—ñ—Ö!", "–ü—Ä–æ–≥–Ω–æ–∑ –æ–ø–ª–∞—á–µ–Ω–æ —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!");
                    } else if (currentEmail && currentEmail.includes('@')) {
                        // User typed email but didn't click "Send Report" yet
                        showModal("–û–ø–ª–∞—á–µ–Ω–æ!", "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –º–µ–Ω—ñ –∑–≤—ñ—Ç'!");
                    } else {
                        // No email at all -> Ask for it
                        upsellEmailModal.style.display = 'flex';
                    }

                } catch (error) {
                    console.error("Upsell failed:", error);
                    showModal("–ü–æ–º–∏–ª–∫–∞", "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ –ø–ª–∞—Ç—ñ–∂. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.");
                    btnElement.classList.remove('loading');
                    btnElement.disabled = false;
                    btnElement.querySelector('.btn-text').innerText = originalText;
                }
            }

            ltvUpsellBtn.addEventListener('click', () => handleUpsellPayment(ltvUpsellBtn));
            lateUpsellBtn.addEventListener('click', () => handleUpsellPayment(lateUpsellBtn));
            closeLateUpsellBtn.addEventListener('click', () => {
                lateUpsellModal.style.display = 'none';
            });

            async function handleDownloadPDF(btnElement, type = 'main') {
                setButtonLoading(btnElement, true);

                if (!generatedReportData) {
                    showModal("–ü–æ–º–∏–ª–∫–∞", "–î–∞–Ω—ñ –∑–≤—ñ—Ç—É —â–µ –Ω–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ.");
                    setButtonLoading(btnElement, false);
                    return;
                }

                try {
                    let enrichedHtml = cleanHtmlForPdf(generatedReportData);
                    const styles = Array.from(document.styleSheets)
                        .map(sheet => {
                            try {
                                return Array.from(sheet.cssRules)
                                    .map(rule => rule.cssText)
                                    .join('\n');
                            } catch (e) {
                                return '';
                            }
                        })
                        .join('\n');

                    const response = await fetch(PDF_BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            reportHtml: enrichedHtml,
                            reportStyles: styles,
                            userData: userBirthData,
                            reportType: type // Pass type
                        })
                    });

                    if (!response.ok) throw new Error("Backend error");

                    const result = await response.json();

                    if (result.success && result.pdfBase64) {
                        const pdfBlob = base64ToBlob(result.pdfBase64, 'application/pdf');
                        const url = URL.createObjectURL(pdfBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = result.filename || 'DestinyCode_Report.pdf';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } else {
                        throw new Error("Invalid response");
                    }

                } catch (error) {
                    showModal("–ü–æ–º–∏–ª–∫–∞", `–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF: ${error.message}`);
                } finally {
                    setButtonLoading(btnElement, false);
                }
            }

            function cleanHtmlForPdf(htmlContent) {
                if (!htmlContent) return '';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;

                // Remove the astro data box from PDF because we generate it separately on backend
                const astroBox = tempDiv.querySelector('.astro-data-box');
                if (astroBox) {
                    astroBox.remove();
                }

                return tempDiv.innerHTML;
            }

            function base64ToBlob(base64, mimeType) {
                const byteCharacters = atob(base64);
                const byteArrays = [];
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    byteArrays.push(new Uint8Array(byteNumbers));
                }
                return new Blob(byteArrays, {
                    type: mimeType
                });
            }

            shareReportBtn.addEventListener('click', () => {
                showModal("–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è", "–§—É–Ω–∫—Ü—ñ—è '–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è' —Å–∫–æ—Ä–æ –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞!<br><br>(–ö–æ–ª–∏ –º–∏ —Ä–µ–∞–ª—ñ–∑—É—î–º–æ –ø–æ—Å—Ç—ñ–π–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.)");
            });

            async function handlePaymentReturn() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('payment') && urlParams.get('payment') === 'success') {
                    showStep('paymentSuccessReturn');

                    let savedData;
                    try {
                        savedData = JSON.parse(sessionStorage.getItem('destinyCodeData'));
                        sessionStorage.removeItem('destinyCodeData');
                    } catch (e) {
                        console.error("Could not retrieve data from sessionStorage:", e);
                    }

                    if (savedData && savedData.date) {
                        userBirthData = savedData;
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        showStep('success');
                    } else {
                        showModal("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Å—ñ—ó", "–ü–ª–∞—Ç—ñ–∂ –ø—Ä–æ–π—à–æ–≤, –∞–ª–µ –º–∏ –Ω–µ –∑–º–æ–≥–ª–∏ –∑–Ω–∞–π—Ç–∏ –≤–∞—à—ñ –¥–∞–Ω—ñ. –ë—É–¥—å –ª–∞—Å–∫–∞, –ø–æ—á–Ω—ñ—Ç—å —Å–ø–æ—á–∞—Ç–∫—É.");
                        showStep('landing');
                    }
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            function applyGoldThemeToSVG(container) {
                if (!container) return;
                const svg = container.querySelector('svg');
                if (!svg) return;

                svg.style.backgroundColor = 'transparent';

                const lines = svg.querySelectorAll('line, circle, path');
                lines.forEach(line => {
                    const stroke = line.getAttribute('stroke');
                    if (!stroke || stroke === '#000000' || stroke === '#000' || stroke === 'black') {
                        line.setAttribute('stroke', '#cda45e');
                        line.setAttribute('stroke-width', '1.5');
                    }
                });

                const texts = svg.querySelectorAll('text');
                texts.forEach(text => {
                    text.setAttribute('fill', '#cda45e');
                    text.style.fill = '#cda45e';
                    text.style.fontFamily = "'Montserrat', sans-serif";
                    text.style.fontWeight = '500';
                });
                console.log("üé® Chart recolored to Gold Theme.");
            }

            async function fetchFullAnalysis(data, email) {
                initAstroLibrary();
                let userQuery = `–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${data.date}.`;
                if (data.time) userQuery += ` –ß–∞—Å: ${data.time}.`;
                if (data.city) userQuery += ` –ú—ñ—Å—Ç–æ: ${data.city}.`;

                let astroDataString = "";
                let horoscope = null;
                let calculationGeo = data.geo;

                if (!calculationGeo) {
                    console.log("‚ö†Ô∏è No GEO data provided. Using default (Kyiv) for calculation fallback.");
                    calculationGeo = {
                        latitude: 50.45,
                        longitude: 30.52,
                        timezone: "Europe/Kyiv"
                    };
                }

                if (Horoscope && data.date && calculationGeo) {
                    try {
                        console.log("üîÆ Starting Horoscope Calculation...");
                        const dateParts = data.date.split('-');
                        const year = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]) - 1;
                        const dateNum = parseInt(dateParts[2]);

                        let hour = 12,
                            minute = 0;
                        if (data.time) {
                            const timeParts = data.time.split(':');
                            hour = parseInt(timeParts[0]);
                            minute = parseInt(timeParts[1]);
                        }

                        const origin = new Origin({
                            year: year,
                            month: month,
                            date: dateNum,
                            hour: hour,
                            minute: minute,
                            latitude: parseFloat(calculationGeo.latitude),
                            longitude: parseFloat(calculationGeo.longitude),
                            timezone: calculationGeo.timezone
                        });

                        horoscope = new Horoscope({
                            origin: origin,
                            houseSystem: "placidus",
                            zodiac: "tropical"
                        });
                        console.log("‚úÖ Horoscope calculated successfully.");
                    } catch (err) {
                        console.error("‚ùå Failed to calculate horoscope (Math Error):", err);
                    }
                } else {
                    console.log("‚ö†Ô∏è Calculating report completely without GEO data (should not happen with fallback).");
                }

                if (horoscope) {
                    try {
                        const planetsList = [];
                        const bodies = horoscope.CelestialBodies;

                        const fullBodyKeys = ['sun', 'moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto', 'ascendant', 'midheaven'];

                        fullBodyKeys.forEach(key => {
                            let body = bodies[key];
                            if (!body && key === 'ascendant') body = horoscope.Ascendant;
                            if (!body && key === 'midheaven') body = horoscope.Midheaven;

                            if (body) {
                                const sign = body.Sign.label;
                                const fullDegree = body.ChartPosition.Ecliptic.DecimalDegrees % 30;
                                const degree = Math.floor(fullDegree);
                                const minutesRaw = (fullDegree - degree) * 60;
                                const minute = Math.floor(minutesRaw);
                                const seconds = Math.round((minutesRaw - minute) * 60);

                                const label = key.charAt(0).toUpperCase() + key.slice(1);
                                planetsList.push(`${label}:${sign} ${degree}¬∞ ${minute}' ${seconds}"`);
                            }
                        });

                        if (planetsList.length > 0) {
                            userBirthData.planets = planetsList;
                            console.log(`‚úÖ PDF Data Verified in fetchFullAnalysis: ${planetsList.length} planets.`);
                        }

                        const precisePlanetsText = planetsList.join('\n');

                        astroDataString = `
                        == –¢–µ—Ö–Ω—ñ—á–Ω—ñ –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω—ñ –î–∞–Ω—ñ (–¥–ª—è –∞–Ω–∞–ª—ñ–∑—É) ==
                        –í–ê–ñ–õ–ò–í–û: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ç–æ—á–Ω—ñ –≥—Ä–∞–¥—É—Å–∏ –¥–ª—è –≥–ª–∏–±–æ–∫–æ—ó —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—ó (–∞—Å–ø–µ–∫—Ç–∏, –∫—Ä–∏—Ç–∏—á–Ω—ñ –≥—Ä–∞–¥—É—Å–∏).
                        
                        [–¢–æ—á–Ω—ñ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏]
                        ${precisePlanetsText}
                        
                        [–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –î–æ–º–∞—Ö]
                        * –°–æ–Ω—Ü–µ: ${horoscope.CelestialBodies.sun.House.label} –î—ñ–º
                        * –ú—ñ—Å—è—Ü—å: ${horoscope.CelestialBodies.moon.House.label} –î—ñ–º
                        * –í–µ–Ω–µ—Ä–∞: ${horoscope.CelestialBodies.venus.House.label} –î—ñ–º
                        * –ú–∞—Ä—Å: ${horoscope.CelestialBodies.mars.House.label} –î—ñ–º
                        * –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç: ${horoscope.Ascendant.Sign.label}
                        * Midheaven: ${horoscope.Midheaven.Sign.label}
                        * –ü—ñ–≤–Ω—ñ—á–Ω–∏–π –í—É–∑–æ–ª: ${horoscope.CelestialBodies.northnode.House.label} –î—ñ–º
                        
                        == –ö—ñ–Ω–µ—Ü—å –¢–µ—Ö–Ω—ñ—á–Ω–∏—Ö –î–∞–Ω–∏—Ö ==
                        `;
                    } catch (err) {
                        console.error("‚ùå Failed to generate planet list/astro string:", err);
                    }
                }

                if (horoscope && Renderer && chartHiddenRender) {
                    try {
                        console.log("üé® Starting SVG Rendering...");
                        chartHiddenRender.innerHTML = '';
                        const renderer = new Renderer(horoscope);
                        renderer.render(chartHiddenRender);

                        applyGoldThemeToSVG(chartHiddenRender);
                        const svgContent = chartHiddenRender.innerHTML;

                        if (svgContent && svgContent.length > 100) {
                            userBirthData.chartSvg = svgContent;
                            console.log("‚úÖ Chart SVG generated successfully (Gold Themed). Length:", svgContent.length);
                        } else {
                            console.warn("‚ö†Ô∏è Renderer finished but output is empty.");
                            userBirthData.chartSvg = null;
                        }
                    } catch (renderErr) {
                        console.error("‚ùå Renderer CRASHED:", renderErr);
                        userBirthData.chartSvg = null;
                    }
                } else {
                    if (horoscope && !Renderer) console.warn("‚ö†Ô∏è Renderer not available.");
                    if (horoscope && !chartHiddenRender) console.warn("‚ö†Ô∏è Hidden Div missing.");
                }

                const finalUserQuery = userQuery + astroDataString;
                // üî• Uses Proxy function now
                const rawJsonString = await callGeminiAPI("gemini-2.5-flash", fullTaskPrompt, finalUserQuery);

                let formattedReportHTML = '';
                try {
                    const reportData = JSON.parse(rawJsonString);

                    if (reportData.error) {
                        formattedReportHTML = `<p>${reportData.message || '–°—Ç–∞–ª–∞—Å—è –Ω–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞.'}</p>`;
                    } else if (reportData && reportData.sections) {
                        for (const section of reportData.sections) {
                            const formattedText = section.analysis_text
                                .split('\n')
                                .filter(line => line.trim().length > 0)
                                .map(line => `<p>${line.trim().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`)
                                .join('');

                            const formattedAdvice = section.practical_advice
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/\\n/g, '<br>');

                            formattedReportHTML += `
                                <div class="report-section mb-6">
                                    <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--accent-color); margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color);">
                                        ${section.icon || '‚ú®'} ${section.title}
                                    </h2>
                                    
                                    <div class="report-content-text text-left leading-relaxed space-y-4" style="color: var(--secondary-text-color);">
                                        ${formattedText}
                                    </div>
                                    
                                    <div class="report-advice mt-4">
                                        <strong style="color: var(--accent-color);">–ü—Ä–∞–∫—Ç–∏—á–Ω–∞ –ü–æ—Ä–∞–¥–∞:</strong>
                                        <p class="mt-2" style="color: var(--primary-text-color); opacity: 0.9;">${formattedAdvice}</p>
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        throw new Error("Invalid JSON structure from API.");
                    }
                } catch (error) {
                    console.error("Failed to parse AI response (JSON):", error, "Raw string:", rawJsonString);
                    formattedReportHTML = `<p>–ù–∞ –∂–∞–ª—å, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ JSON-–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –¢–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏: ${rawJsonString}</p>`;
                }

                const astroHtml = generateAstroDataHTML();
                generatedReportData = formattedReportHTML + astroHtml;

                console.log("Sync: Report FINISHED.");
                isReportReady = true;
                showReportIfReady();

                try {
                    const reportTitleMatch = formattedReportHTML.match(/<h2.*?>(.*?)<\/h2>/i);
                    const reportTitle = reportTitleMatch ?
                        reportTitleMatch[1].replace(/<.*?>/g, '').trim().replace(/^[^\w]+/, '') :
                        '–í–∞—à –∑–≤—ñ—Ç';

                    const emailResponse = await fetch(EMAIL_BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userEmail: email,
                            reportHtml: formattedReportHTML,
                            reportTitle: reportTitle,
                            reportType: 'main',
                            userData: userBirthData
                        })
                    });

                    if (!emailResponse.ok) throw new Error('Backend failed to send email.');
                    const emailResult = await emailResponse.json();

                } catch (error) {
                    console.error("Failed to send email via backend:", error);
                }
            }

            function updateTimePlaceholder() {
                if (birthTimeInput.value === '') {
                    timePlaceholder.innerText = '–û–±–µ—Ä–∏ —á–∞—Å';
                    timePlaceholder.style.color = 'var(--secondary-text-color)';
                } else {
                    timePlaceholder.innerText = birthTimeInput.value;
                    timePlaceholder.style.color = 'var(--primary-text-color)';
                }
            }

            // Listeners from attached file
            birthTimeInput.addEventListener('input', updateTimePlaceholder);
            birthTimeInput.addEventListener('change', updateTimePlaceholder);
            birthTimeInput.addEventListener('blur', updateTimePlaceholder);
            birthTimeInput.addEventListener('touchend', () => setTimeout(updateTimePlaceholder, 500));
            
            updateTimePlaceholder();

            birthCityInput.addEventListener('input', () => {
                cityErrorMessage.style.display = 'none';
                cityInfoMessage.style.display = 'none';
                birthCityInput.classList.remove('input-error');
            });

            handlePaymentReturn();
        });
    </script>
</body>

</html>
